<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Osiris - Vestite para ganar</title>
	
		<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23d97706' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='m2 4 3 12h14l3-12-6 7-4-3-4 3-6-7z'/%3E%3C/svg%3E">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts: Usamos Playfair Display para títulos (elegancia) e Inter para UI -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f5f5f4; }
        h1, h2, h3, .brand-font { font-family: 'Playfair Display', serif; }
        
        /* Scrollbar personalizada */
        .custom-scrollbar::-webkit-scrollbar { width: 5px; height: 5px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #d6d3d1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #a8a29e; }
        
        /* Sidebar Scrollbar */
        .sidebar-scrollbar::-webkit-scrollbar { width: 4px; }
        .sidebar-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .sidebar-scrollbar::-webkit-scrollbar-thumb { background: #44403c; border-radius: 10px; }
        
        .chart-bar { transition: height 1s ease-out; }
        
        /* Animaciones */
        @keyframes slideIn {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .toast-enter { animation: slideIn 0.3s ease-out forwards; }
        .fade-in { animation: fadeIn 0.3s ease-out forwards; }

        /* Estilos móvil */
        .mobile-nav-item {
            @apply flex flex-col items-center justify-center text-stone-400 transition-colors py-2 flex-1;
        }
        .mobile-nav-item.active {
            @apply text-amber-600;
        }
        .mobile-nav-item.active svg {
            @apply stroke-[2.5px];
        }
        
        /* Utiliarios estéticos */
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        /* Ocultar scrollbar en elementos horizontales móvil */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>

    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.344.0",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js"
      }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="text-stone-800 h-screen w-screen overflow-hidden">
    <div id="root" class="h-full w-full"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Check, X, TrendingUp, DollarSign, Calendar, Search, 
            Trash2, Award, Zap, Plus, AlertCircle, BarChart3, 
            BrainCircuit, Home, PieChart, Star, Pencil, Filter, 
            MoreHorizontal, ChevronLeft, ChevronRight, MapPin, 
            Settings, Loader2, Wallet, ArrowUpRight, ArrowDownLeft, 
            Banknote, CreditCard, TrendingDown, Activity, Info, 
            LogOut, Lock, Shield, User, Coins, ShoppingBag, 
            AlertTriangle, Tag, Receipt, CheckCircle2, Circle, 
            Truck, Phone, Mail, ArrowUpCircle, ArrowDownCircle, 
            Clock, Edit3, Crown, Layers, Scissors, Shirt, Users,
            Package, FileText, ClipboardList, ChevronDown, ChevronUp,
            CalendarClock, Menu, Grid, ShoppingCart
        } from 'lucide-react';

        // --- FIREBASE SETUP ---
        import { initializeApp } from "firebase/app";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "firebase/auth";
        import { getFirestore, collection, doc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, query, writeBatch, getDoc } from "firebase/firestore";

        // ==========================================
        // CONFIGURACIÓN OSIRIS
        // ==========================================
        const localConfig = {
          apiKey: "AIzaSyBySeGvkm4FmyDlP_Jh08TRhJiP1Qf7SXw",
          authDomain: "osiris-42dac.firebaseapp.com",
          projectId: "osiris-42dac",
          storageBucket: "osiris-42dac.firebasestorage.app",
          messagingSenderId: "511429334828",
          appId: "1:511429334828:web:6cdb5fd8de60610c0a3e89",
          measurementId: "G-ZYRJ71P9SE"
        };

        let firebaseConfig;
        let isConfigured = true;

        if (typeof __firebase_config !== 'undefined' && __firebase_config) {
            firebaseConfig = JSON.parse(__firebase_config);
        } else {
            firebaseConfig = localConfig;
        }

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'osiris-prod-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, auth, db;
        
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            console.error("Error inicializando Firebase:", e);
            isConfigured = false;
        }

        // --- UTILS & COMPONENTS ---
        const getHash = (str) => {
            if (!str) return 0;
            let hash = 0;
            for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
            return hash;
        };

        const BrandIcon = ({ size = 24, className = "" }) => (
            <Crown size={size} className={className} strokeWidth={1.5} />
        );

        const identifyCategory = (text) => {
            if (!text) return 'Varios';
            const t = text.toLowerCase();
            if (t.includes('remera') || t.includes('camisa') || t.includes('chomba') || t.includes('top')) return 'Superior';
            if (t.includes('pantalon') || t.includes('jean') || t.includes('short') || t.includes('pollera')) return 'Inferior';
            if (t.includes('zapatilla') || t.includes('zapato') || t.includes('bota')) return 'Calzado';
            if (t.includes('campera') || t.includes('buzo') || t.includes('chaleco')) return 'Abrigo';
            if (t.includes('accesorio') || t.includes('cinto') || t.includes('gorra')) return 'Accesorios';
            if (t.includes('vestido') || t.includes('mono')) return 'Trajes';
            return 'Varios';
        };

        const getSmartIconName = (description) => {
            if (!description) return 'bag';
            const cat = identifyCategory(description);
            switch(cat) {
                case 'Superior': return 'layers';
                case 'Inferior': return 'tag'; 
                case 'Abrigo': return 'layers';
                case 'Calzado': return 'bag'; 
                case 'Accesorios': return 'star';
                case 'Trajes': return 'crown';
                default: return 'bag';
            }
        };

        const generateColorFromText = (text) => {
            if (!text) return '#D97706'; 
            let hash = 0;
            for (let i = 0; i < text.length; i++) hash = text.charCodeAt(i) + ((hash << 5) - hash);
            const colors = ['#D97706', '#B45309', '#78716C', '#451a03', '#0f172a', '#1e293b']; 
            return colors[Math.abs(hash) % colors.length];
        };

        const SmartIcon = ({ iconName, color, detail }) => {
            const IconMap = { 'layers': Layers, 'tag': Tag, 'bag': ShoppingBag, 'crown': Crown, 'star': Award, 'scissors': Edit3 };
            const IconComponent = IconMap[iconName] || ShoppingBag;
            return (
                <div className="relative w-12 h-12 rounded-xl flex items-center justify-center overflow-hidden shadow-sm bg-white border border-stone-100">
                    <div className="absolute inset-0 opacity-10" style={{ backgroundColor: color }}></div>
                    <IconComponent size={22} color={color} strokeWidth={1.5} />
                </div>
            );
        };

        // --- CUSTOM SELECTOR COMPONENT ---
        const ClientSelector = ({ clients, value, onChange }) => {
            const [isOpen, setIsOpen] = useState(false);
            const wrapperRef = useRef(null);

            const filtered = clients.filter(c => c.name.toLowerCase().includes(value.toLowerCase()));

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (wrapperRef.current && !wrapperRef.current.contains(event.target)) {
                        setIsOpen(false);
                    }
                };
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, [wrapperRef]);

            return (
                <div className="relative" ref={wrapperRef}>
                    <div className="relative">
                        <input
                            type="text"
                            className="w-full p-3.5 pl-4 pr-10 bg-stone-50 border border-stone-200 rounded-xl focus:border-stone-400 outline-none font-medium transition-all"
                            placeholder="Buscar o crear cliente..."
                            value={value}
                            onChange={(e) => { onChange(e.target.value); setIsOpen(true); }}
                            onFocus={() => setIsOpen(true)}
                        />
                        <button 
                            type="button"
                            onClick={() => setIsOpen(!isOpen)}
                            className="absolute right-3 top-1/2 -translate-y-1/2 text-stone-400 hover:text-stone-600 p-1"
                        >
                            {isOpen ? <ChevronUp size={18} /> : <ChevronDown size={18} />}
                        </button>
                    </div>
                    
                    {isOpen && (
                        <div className="absolute z-50 w-full mt-1 bg-white border border-stone-100 rounded-xl shadow-xl max-h-60 overflow-y-auto custom-scrollbar animate-in fade-in zoom-in-95 duration-200">
                            {filtered.length > 0 ? filtered.map((c) => (
                                <button
                                    key={c.id}
                                    type="button"
                                    className="w-full text-left px-4 py-3 hover:bg-stone-50 text-sm font-medium text-stone-700 flex justify-between items-center transition-colors border-b border-stone-50 last:border-0"
                                    onClick={() => { onChange(c.name); setIsOpen(false); }}
                                >
                                    <span>{c.name}</span>
                                    {c.stats?.debt > 0 && <span className="text-[10px] bg-red-50 text-red-500 px-2 py-0.5 rounded-full font-bold">Deuda: ${c.stats.debt}</span>}
                                </button>
                            )) : (
                                <div className="p-4 text-center">
                                    {value ? (
                                        <>
                                            <p className="text-sm text-stone-400 mb-1">Cliente no encontrado</p>
                                            <p className="text-xs text-amber-600 font-bold">Se creará nuevo al guardar</p>
                                        </>
                                    ) : (
                                        <p className="text-sm text-stone-400">Escribe para buscar...</p>
                                    )}
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        };

        const ConfigErrorScreen = () => (
            <div className="h-full w-full bg-stone-950 flex items-center justify-center p-4">
                <div className="bg-white max-w-lg w-full rounded-md p-8 shadow-2xl text-stone-800 border-t-4 border-red-600">
                    <div className="text-red-600 mb-4"><AlertCircle size={48} /></div>
                    <h1 className="text-2xl font-bold mb-2 brand-font">Error de Conexión</h1>
                    <p className="text-stone-500 mb-6">No se pudo establecer conexión con Osiris Database.</p>
                    <button onClick={() => window.location.reload()} className="px-6 py-2 bg-stone-900 text-white font-medium hover:bg-stone-800">Reintentar</button>
                </div>
            </div>
        );

        const LoginScreen = ({ onLogin, credentials }) => {
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [isLoading, setIsLoading] = useState(false);

            const handleSubmit = (e) => {
                e.preventDefault();
                setError('');
                setIsLoading(true);
                setTimeout(() => {
                    if (username === credentials.user && password === credentials.pass) {
                        onLogin();
                    } else {
                        setError('Credenciales inválidas');
                        setIsLoading(false);
                    }
                }, 800);
            };

            return (
                <div className="h-full w-full bg-[#0c0a09] flex flex-col items-center justify-center p-4 relative overflow-hidden">
                    <div className="absolute top-0 left-0 w-full h-full overflow-hidden pointer-events-none">
                        <div className="absolute -top-[20%] -right-[20%] w-[60%] h-[60%] bg-amber-900/10 rounded-full blur-3xl"></div>
                        <div className="absolute top-[40%] -left-[10%] w-[40%] h-[40%] bg-stone-800/20 rounded-full blur-3xl"></div>
                    </div>

                    <div className="w-full max-w-sm relative z-10">
                        <div className="text-center mb-10">
                            <div className="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-amber-500 to-amber-700 rounded-2xl shadow-2xl shadow-amber-900/30 mb-6">
                                <BrandIcon size={40} className="text-white" />
                            </div>
                            <h1 className="text-4xl font-bold text-white brand-font tracking-wide mb-2">OSIRIS</h1>
                            <p className="text-stone-400 text-sm tracking-[0.2em] uppercase">Vestite para ganar</p>
                        </div>

                        <form onSubmit={handleSubmit} className="space-y-4 bg-white/5 p-8 rounded-2xl backdrop-blur-sm border border-white/10 shadow-2xl">
                            <div className="space-y-1">
                                <label className="text-xs font-bold text-stone-500 uppercase tracking-widest ml-1">Usuario</label>
                                <input 
                                    type="text" 
                                    className="w-full px-4 py-3 bg-stone-900/50 border border-stone-800 rounded-lg text-white focus:border-amber-600 focus:ring-1 focus:ring-amber-600 outline-none transition-all placeholder:text-stone-700"
                                    placeholder="Usuario" 
                                    value={username} 
                                    onChange={(e) => setUsername(e.target.value)} 
                                    autoFocus 
                                />
                            </div>
                            <div className="space-y-1">
                                <label className="text-xs font-bold text-stone-500 uppercase tracking-widest ml-1">Contraseña</label>
                                <input 
                                    type="password" 
                                    className="w-full px-4 py-3 bg-stone-900/50 border border-stone-800 rounded-lg text-white focus:border-amber-600 focus:ring-1 focus:ring-amber-600 outline-none transition-all placeholder:text-stone-700"
                                    placeholder="••••••••" 
                                    value={password} 
                                    onChange={(e) => setPassword(e.target.value)} 
                                />
                            </div>
                            {error && <div className="text-red-400 text-xs font-medium text-center py-2 animate-pulse">{error}</div>}
                            
                            <button 
                                type="submit" 
                                disabled={isLoading}
                                className="w-full bg-gradient-to-r from-amber-600 to-amber-700 hover:from-amber-500 hover:to-amber-600 text-white py-3.5 rounded-lg font-medium shadow-lg transition-all active:scale-95 disabled:opacity-70 mt-2 tracking-wide"
                            >
                                {isLoading ? <Loader2 size={20} className="animate-spin mx-auto" /> : 'INGRESAR'}
                            </button>
                        </form>
                        
                        {/* FIRMA DEVELOPER */}
                        <div className="text-center mt-10 space-y-1">
                            <p className="text-stone-600 text-[10px]">© {new Date().getFullYear()} Osiris Management System</p>
                            <p className="text-stone-700 text-[10px] font-medium opacity-60 hover:opacity-100 transition-opacity cursor-default">Powered by JA • Javier Amado • javieramado91@gmail.com</p>
                        </div>
                    </div>
                </div>
            );
        };

        // Modal Actualizado para aceptar maxWidth
        const Modal = ({ isOpen, onClose, title, children, maxWidth = "max-w-md" }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm animate-in fade-in duration-200">
                    <div className={`bg-white rounded-2xl shadow-2xl w-full ${maxWidth} overflow-hidden animate-in zoom-in-95 slide-in-from-bottom-4 duration-300 flex flex-col max-h-[90vh]`}>
                        <div className="flex justify-between items-center px-6 py-5 border-b border-stone-100 bg-stone-50/50 shrink-0">
                            <h3 className="font-bold text-lg text-stone-900 brand-font">{title}</h3>
                            <button onClick={onClose} className="p-2 hover:bg-stone-200 rounded-full transition-colors text-stone-400 hover:text-stone-600"><X size={20} /></button>
                        </div>
                        <div className="p-6 overflow-y-auto custom-scrollbar">{children}</div>
                    </div>
                </div>
            );
        };

        const ConfirmModal = ({ isOpen, onClose, title, message, onConfirm, isDanger, confirmText = "Confirmar" }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[70] flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 text-center animate-in zoom-in-95 duration-200">
                        <div className={`mx-auto w-12 h-12 rounded-full flex items-center justify-center mb-4 ${isDanger ? 'bg-red-50 text-red-500' : 'bg-stone-100 text-stone-500'}`}>
                            {isDanger ? <Trash2 size={24} /> : <AlertCircle size={24} />}
                        </div>
                        <h3 className="text-lg font-bold text-stone-900 mb-2 brand-font">{title}</h3>
                        <p className="text-stone-500 text-sm mb-6">{message}</p>
                        <div className="flex gap-3">
                            <button onClick={onClose} className="flex-1 py-2.5 rounded-lg font-medium bg-stone-100 text-stone-600 hover:bg-stone-200">Cancelar</button>
                            <button onClick={() => { onConfirm(); onClose(); }} className={`flex-1 py-2.5 rounded-lg font-medium text-white ${isDanger ? 'bg-red-600 hover:bg-red-700' : 'bg-stone-900 hover:bg-stone-800'}`}>{confirmText}</button>
                        </div>
                    </div>
                </div>
            );
        };

        const Toast = ({ message, type, onClose }) => {
            useEffect(() => { const t = setTimeout(onClose, 4000); return () => clearTimeout(t); }, [onClose]);
            return (
                <div className={`toast-enter fixed bottom-6 right-6 z-[80] px-5 py-4 rounded-lg shadow-2xl flex items-center gap-3 border-l-4 ${type === 'success' ? 'bg-stone-900 text-white border-amber-500' : 'bg-white text-stone-800 border-red-500'}`}>
                    {type === 'success' ? <Check size={18} className="text-amber-500" /> : <AlertCircle size={18} className="text-red-500" />}
                    <span className="font-medium text-sm">{message}</span>
                </div>
            );
        };

        const SimpleChart = ({ data }) => {
            if (!data || data.length === 0) return <div className="h-32 flex items-center justify-center text-stone-400 text-xs">Sin datos suficientes</div>;
            const maxVal = Math.max(...data.map(d => d.value));
            return (
                <div className="flex items-end gap-1 h-32 pt-4 pb-0 w-full">
                    {data.map((d, i) => (
                        <div key={i} className="flex-1 flex flex-col items-center gap-1 group">
                            <div className="w-full bg-amber-500/20 rounded-t-sm relative group-hover:bg-amber-500 transition-colors chart-bar" style={{ height: maxVal > 0 ? `${(d.value / maxVal) * 100}%` : '0%' }}></div>
                            <span className="text-[9px] text-stone-400 font-medium truncate w-full text-center">{d.label}</span>
                        </div>
                    ))}
                </div>
            );
        };

        const OsirisApp = () => {
            // Estado y Configuración
            const [isLocked, setIsLocked] = useState(true);
            const [credentials, setCredentials] = useState(() => {
                const saved = localStorage.getItem('osiris_credentials');
                return saved ? JSON.parse(saved) : { user: 'Osiris', pass: '1993' };
            });
            const [activeTab, setActiveTab] = useState('orders'); // orders, debts, finances, stats, clients, suppliers
            const [user, setUser] = useState(null);
            
            // Mobile Menu State
            const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);

            // Data Collections
            const [orders, setOrders] = useState([]);
            const [expenses, setExpenses] = useState([]);
            const [debts, setDebts] = useState([]);
            const [incomes, setIncomes] = useState([]); 
            const [clients, setClients] = useState([]);
            const [suppliers, setSuppliers] = useState([]);
            const [supplierOrders, setSupplierOrders] = useState([]);

            const [toasts, setToasts] = useState([]);
            
            // Filtros y Buscadores
            const [orderFilter, setOrderFilter] = useState('all');
            const [searchTerm, setSearchTerm] = useState('');
            const [clientSort, setClientSort] = useState('name');
            const [currentDate, setCurrentDate] = useState(new Date());

            // Modales Generales
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [confirmModal, setConfirmModal] = useState({ isOpen: false, title: '', message: '', onConfirm: () => {}, isDanger: false, confirmText: 'Confirmar' });
            
            // Order State (CART FUNCTIONALITY ADDED)
            const [editingId, setEditingId] = useState(null);
            // Form structure updated to support items array
            const [form, setForm] = useState({ client: '', items: [], price: 0, paid: false, paymentMethod: null, delivered: false, important: false, date: '', note: '' });
            // Temporary line item state for the "Cart"
            const [lineItem, setLineItem] = useState({ detail: '', quantity: 1, unitPrice: '' });
            
            // Payment/Delivery
            const [isPaymentModalOpen, setIsPaymentModalOpen] = useState(false);
            const [pendingPaymentId, setPendingPaymentId] = useState(null);
            const [paymentModalStep, setPaymentModalStep] = useState('select');
            const [mixedAmounts, setMixedAmounts] = useState({ cash: 0, transfer: 0 });
			const [partialAmount, setPartialAmount] = useState('');

			const [partialMethod, setPartialMethod] = useState('cash');

            const [isDeliveryModalOpen, setIsDeliveryModalOpen] = useState(false);
            const [pendingDeliveryId, setPendingDeliveryId] = useState(null);
            const [deliveryDateInput, setDeliveryDateInput] = useState('');

	// Estados para "Hecho" (Step 1)
     	   const [isDoneModalOpen, setIsDoneModalOpen] = useState(false);
       	 const [pendingDoneId, setPendingDoneId] = useState(null);
       	 const [doneDateInput, setDoneDateInput] = useState('');

            // Finance Modals States (Actualizado con mixedCash/mixedTransfer)
            const [isExpenseModalOpen, setIsExpenseModalOpen] = useState(false);
            const [expenseForm, setExpenseForm] = useState({ description: '', amount: '', method: 'cash', mixedCash: '', mixedTransfer: '', date: new Date().toISOString() });
            const [editingFinanceId, setEditingFinanceId] = useState(null);
            
            const [isIncomeModalOpen, setIsIncomeModalOpen] = useState(false);
            const [incomeForm, setIncomeForm] = useState({ description: '', amount: '', method: 'cash', mixedCash: '', mixedTransfer: '', date: new Date().toISOString() });

            // DEBT STATES - ACTUALIZADO
            const [isDebtModalOpen, setIsDebtModalOpen] = useState(false);
            const [isDebtStatsModalOpen, setIsDebtStatsModalOpen] = useState(false);
            const [debtForm, setDebtForm] = useState({ 
                mode: 'single', // 'single', 'installments', 'fixed'
                detail: '', 
                amount: '', 
                quotaCount: 1,
                startMonth: new Date().toISOString().slice(0, 7), // YYYY-MM
                year: new Date().getFullYear()
            });

            // Client/Supplier Modals
            const [isClientModalOpen, setIsClientModalOpen] = useState(false);
            const [clientForm, setClientForm] = useState({ name: '', phone: '', email: '', address: '', notes: '' });
            const [editingClientId, setEditingClientId] = useState(null);
            const [isClientStatsModalOpen, setIsClientStatsModalOpen] = useState(false);
            
            const [isSupplierModalOpen, setIsSupplierModalOpen] = useState(false);
            const [supplierForm, setSupplierForm] = useState({ name: '', cuit: '', phone: '', address: '', products: '', notes: '' });
            const [editingSupplierId, setEditingSupplierId] = useState(null);

            const [isSupplierOrderModalOpen, setIsSupplierOrderModalOpen] = useState(false);
            const [supplierOrderForm, setSupplierOrderForm] = useState({ supplierId: '', detail: '', amount: '', date: new Date().toISOString().split('T')[0], received: false });

            const [clientPromptData, setClientPromptData] = useState(null);

            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [tempCredentials, setTempCredentials] = useState({ user: '', pass: '' });

            const [isSaving, setIsSaving] = useState(false);
            const [connectionStatus, setConnectionStatus] = useState('checking');
			const [financeFilter, setFinanceFilter] = useState('all');
            // --- AUTH & INIT ---
            useEffect(() => {
                const savedAuth = localStorage.getItem('osiris_auth_token');
                if (savedAuth === `valid_${credentials.pass}`) setIsLocked(false);

                if (!isConfigured) return;
                const initAuth = async () => {
                    try { 
                        if (initialAuthToken) await signInWithCustomToken(auth, initialAuthToken);
                        else await signInAnonymously(auth);
                    } catch (e) { 
                        console.error("Auth error:", e);
                        setConnectionStatus('disconnected');
                    }
                };
                initAuth();
                const unsubscribe = onAuthStateChanged(auth, (u) => { 
                    setUser(u); 
                    if (u) setConnectionStatus('connected');
                    else setConnectionStatus('disconnected');
                });
                return () => unsubscribe();
            }, []);

            // --- DATA SYNC ---
            useEffect(() => {
                if (!user || !isConfigured) return;
                
                const ordersRef = collection(db, 'artifacts', appId, 'public', 'data', 'orders');
                const unsubOrders = onSnapshot(query(ordersRef), (s) => {
                    setOrders(s.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => {
                        const dateA = new Date(a.createdAt || a.date);
                        const dateB = new Date(b.createdAt || b.date);
                        return dateB - dateA;
                    }));
                });
                
                const expensesRef = collection(db, 'artifacts', appId, 'public', 'data', 'expenses');
                const unsubExpenses = onSnapshot(query(expensesRef), (s) => setExpenses(s.docs.map(d => ({ id: d.id, ...d.data() }))));

                const debtsRef = collection(db, 'artifacts', appId, 'public', 'data', 'debts');
                const unsubDebts = onSnapshot(query(debtsRef), (s) => setDebts(s.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b) => new Date(a.date) - new Date(b.date))));
                
                const incomesRef = collection(db, 'artifacts', appId, 'public', 'data', 'extra_incomes');
                const unsubIncomes = onSnapshot(query(incomesRef), (s) => setIncomes(s.docs.map(d => ({ id: d.id, ...d.data() }))));

                const clientsRef = collection(db, 'artifacts', appId, 'public', 'data', 'clients');
                const unsubClients = onSnapshot(query(clientsRef), (s) => setClients(s.docs.map(d => ({ id: d.id, ...d.data() }))));

                const suppliersRef = collection(db, 'artifacts', appId, 'public', 'data', 'suppliers');
                const unsubSuppliers = onSnapshot(query(suppliersRef), (s) => setSuppliers(s.docs.map(d => ({ id: d.id, ...d.data() }))));

                const suppOrderRef = collection(db, 'artifacts', appId, 'public', 'data', 'supplier_orders');
                const unsubSuppOrders = onSnapshot(query(suppOrderRef), (s) => setSupplierOrders(s.docs.map(d => ({ id: d.id, ...d.data() }))));

                return () => { unsubOrders(); unsubExpenses(); unsubIncomes(); unsubDebts(); unsubClients(); unsubSuppliers(); unsubSuppOrders(); };
            }, [user]);

            // --- HELPERS ---
            const addToast = (msg, type = 'success') => {
                const id = Date.now();
                setToasts(prev => [...prev, { id, message: msg, type }]);
            };
            const removeToast = (id) => setToasts(prev => prev.filter(t => t.id !== id));

            const handleLogin = () => {
                localStorage.setItem('osiris_auth_token', `valid_${credentials.pass}`);
                setIsLocked(false);
            };

            const handleLogout = () => {
                localStorage.removeItem('osiris_auth_token');
                setIsLocked(true);
            };

            const handleUpdateCredentials = (e) => {
                e.preventDefault();
                if (!tempCredentials.user || !tempCredentials.pass) { addToast('Completa los campos', 'error'); return; }
                setCredentials(tempCredentials);
                localStorage.setItem('osiris_credentials', JSON.stringify(tempCredentials));
                localStorage.setItem('osiris_auth_token', `valid_${tempCredentials.pass}`);
                addToast('Credenciales actualizadas');
                setIsSettingsOpen(false);
            };

            // --- COMPUTED DATA ---
            const changeMonth = (offset) => {
                const newDate = new Date(currentDate);
                newDate.setMonth(newDate.getMonth() + offset);
                setCurrentDate(newDate);
            };
            
            const monthLabel = new Intl.DateTimeFormat('es-AR', { month: 'long', year: 'numeric' }).format(currentDate);
            const capitalizedMonth = monthLabel.charAt(0).toUpperCase() + monthLabel.slice(1);

            const filteredOrders = useMemo(() => orders.filter(o => {
                const d = new Date(o.date);
                const matchesDate = d.getMonth() === currentDate.getMonth() && d.getFullYear() === currentDate.getFullYear();
                const matchesSearch = (o.client + o.detail).toLowerCase().includes(searchTerm.toLowerCase());
                let matchesFilter = true;

	if (orderFilter === 'todo') matchesFilter = !o.done;

                if (orderFilter === 'pending_pay') matchesFilter = !o.paid;
                if (orderFilter === 'pending_delivery') matchesFilter = !o.delivered;

	if (orderFilter === 'done') matchesFilter = o.done;   // <--- ESTA ES LA NUEVA

                if (orderFilter === 'delivered') matchesFilter = o.delivered;
                if (orderFilter === 'important') matchesFilter = o.important;
                return matchesDate && matchesSearch && matchesFilter;
            }), [orders, currentDate, searchTerm, orderFilter]);

            // Client Stats Logic
            const getClientStats = (clientName) => {
                if (!clientName) return { spent: 0, debt: 0, topCategory: '-' };
                const clientOrders = orders.filter(o => o.client.toLowerCase() === clientName.toLowerCase());
                const spent = clientOrders.reduce((acc, o) => acc + o.price, 0);
                const debt = clientOrders.filter(o => !o.paid).reduce((acc, o) => acc + o.price, 0);
                
                // Top Category
                const cats = {};
                clientOrders.forEach(o => {
                    const cat = identifyCategory(o.detail);
                    cats[cat] = (cats[cat] || 0) + 1;
                });
                const topCategory = Object.entries(cats).sort((a,b) => b[1] - a[1])[0]?.[0] || 'Varios';

                return { spent, debt, topCategory, orderCount: clientOrders.length };
            };

            const sortedClients = useMemo(() => {
                const clientsWithStats = clients.map(c => ({
                    ...c,
                    stats: getClientStats(c.name)
                }));
                
                return clientsWithStats.sort((a, b) => {
                    if (clientSort === 'spent') return b.stats.spent - a.stats.spent;
                    if (clientSort === 'debt') return b.stats.debt - a.stats.debt;
                    return a.name.localeCompare(b.name);
                }).filter(c => c.name.toLowerCase().includes(searchTerm.toLowerCase()));
            }, [clients, orders, clientSort, searchTerm]);

            // Global Client Stats for Report Modal
            const globalClientStats = useMemo(() => {
                const allWithStats = clients.map(c => ({...c, stats: getClientStats(c.name)}));
                const totalDebt = allWithStats.reduce((acc, c) => acc + c.stats.debt, 0);
                const totalSpent = allWithStats.reduce((acc, c) => acc + c.stats.spent, 0);
                const avgTicket = allWithStats.length > 0 ? totalSpent / allWithStats.length : 0;
                
                const topSpenders = [...allWithStats].sort((a, b) => b.stats.spent - a.stats.spent).slice(0, 5);
                const topDebtors = [...allWithStats].filter(c => c.stats.debt > 0).sort((a, b) => b.stats.debt - a.stats.debt).slice(0, 5);

                return { totalDebt, avgTicket, topSpenders, topDebtors };
            }, [clients, orders]);


           // FINANCES CALCULATION UPDATED FOR PARTIAL PAYMENTS
            const finances = useMemo(() => {
                const isCurrentMonth = (dateStr) => {
                    const d = new Date(dateStr);
                    return d.getMonth() === currentDate.getMonth() && d.getFullYear() === currentDate.getFullYear();
                };

                const mapFinanceItem = (item, type, source) => ({
                    ...item, type, source,
                    desc: type === 'income' ? (item.client ? `${item.client} - ${item.detail}` : item.description) : item.description,
                    amount: parseFloat(item.amount),
                    date: item.date,
                    paymentMethod: item.paymentMethod || item.method || 'cash',
                    paymentDetails: item.paymentDetails || null
                });

                // 1. Extraer pagos de pedidos (Completos antiguos, Completos nuevos y Parciales)
                const orderMovements = [];
                orders.forEach(o => {
                    // Si tiene historial de pagos (Sistema Nuevo con parciales)
                    if (o.paymentHistory && o.paymentHistory.length > 0) {
                        o.paymentHistory.forEach((h, index) => {
                            orderMovements.push(mapFinanceItem({
                                ...h, 
                                client: o.client, 
                                detail: `Pago ${h.isPartial ? 'Parcial' : 'Final'} (${o.detail})`,
                                id: `${o.id}_pay_${index}`, // ID único artificial para la lista
                                date: h.date
                            }, 'income', 'orders'));
                        });
                    } 
                    // Si está pagado pero NO tiene historial (Sistema Viejo - Retrocompatibilidad)
                    else if (o.paid) {
                        orderMovements.push(mapFinanceItem({
                            ...o, amount: o.price, date: o.paymentDate || o.date
                        }, 'income', 'orders'));
                    }
                });

                // Filtrar por mes actual para los totales del mes
                const monthMovements = orderMovements.filter(m => isCurrentMonth(m.date));
                const monthExpenses = expenses.filter(e => isCurrentMonth(e.date)).map(e => mapFinanceItem(e, 'expense', 'expenses'));
                const monthIncomes = incomes.filter(i => isCurrentMonth(i.date)).map(i => mapFinanceItem(i, 'income', 'extra_incomes'));

                const incomeVal = monthMovements.reduce((acc, m) => acc + m.amount, 0) + monthIncomes.reduce((acc, i) => acc + i.amount, 0);
                const expenseVal = monthExpenses.reduce((acc, e) => acc + e.amount, 0);

                // Helper para sumar por método
                const sumByMethod = (items, targetMethod) => items.reduce((sum, item) => {
                    if (item.paymentMethod === 'mixed' && item.paymentDetails) {
                        return sum + (parseFloat(item.paymentDetails[targetMethod]) || 0);
                    }
                    if (item.paymentMethod === targetMethod || (!item.paymentMethod && targetMethod === 'cash')) {
                        return sum + (parseFloat(item.amount) || 0);
                    }
                    return sum;
                }, 0);

                const allOrderMovements = orderMovements; // Todos los tiempos
                const allExpenses = expenses.map(e => mapFinanceItem(e, 'expense', 'expenses'));
                const allIncomes = incomes.map(i => mapFinanceItem(i, 'income', 'extra_incomes'));

                const totalCash = (sumByMethod(allOrderMovements, 'cash') + sumByMethod(allIncomes, 'cash')) - sumByMethod(allExpenses, 'cash');
                const totalTransfer = (sumByMethod(allOrderMovements, 'transfer') + sumByMethod(allIncomes, 'transfer')) - sumByMethod(allExpenses, 'transfer');

                const movements = [...monthMovements, ...monthIncomes, ...monthExpenses].sort((a, b) => new Date(b.date) - new Date(a.date));

                return { incomeVal, expenseVal, net: incomeVal - expenseVal, totalCash, totalTransfer, totalBalance: totalCash + totalTransfer, movements };
            }, [orders, expenses, incomes, currentDate]);

            const stats = useMemo(() => {
                // Lógica de estadísticas actualizada para contar PAGOS REALES (incluyendo parciales)
                const currentYear = currentDate.getFullYear();
                
                // Recolectar todos los pagos del año (Parciales y Totales)
                const yearPayments = [];
                orders.forEach(o => {
                    if (o.paymentHistory && o.paymentHistory.length > 0) {
                        o.paymentHistory.forEach(h => {
                            if (new Date(h.date).getFullYear() === currentYear) {
                                yearPayments.push({ amount: h.amount, date: h.date, detail: o.detail });
                            }
                        });
                    } else if (o.paid && new Date(o.paymentDate || o.date).getFullYear() === currentYear) {
                        yearPayments.push({ amount: o.price, date: o.paymentDate || o.date, detail: o.detail });
                    }
                });

                const totalRevenue = yearPayments.reduce((acc, p) => acc + p.amount, 0);
                
                const chartData = [];
                const months = ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"];
                months.forEach((m, i) => {
                    const val = yearPayments.filter(p => new Date(p.date).getMonth() === i).reduce((s,p) => s + p.amount, 0);
                    chartData.push({ label: m, value: val });
                });

                const counts = {};
                // Para las categorías seguimos usando pedidos creados/pagados este año
                const yearOrders = orders.filter(o => (o.paid || (o.amountPaid > 0)) && new Date(o.date).getFullYear() === currentYear);
                yearOrders.forEach(o => {
                    const cat = identifyCategory(o.detail);
                    counts[cat] = (counts[cat] || 0) + 1;
                });
                const topCats = Object.keys(counts).map(k => ({ name: k, value: counts[k] })).sort((a,b) => b.value - a.value);

                return { totalRevenue, chartData, topCats, count: yearOrders.length };
            }, [orders, currentDate]);

            // --- DEBT STATS ---
            const debtStats = useMemo(() => {
                const pending = debts.filter(d => !d.paid);
                const byMonth = {};

                pending.forEach(d => {
                    const date = new Date(d.date);
                    // Use YYYY-MM as key
                    const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    if (!byMonth[key]) byMonth[key] = 0;
                    byMonth[key] += d.amount;
                });

                return Object.entries(byMonth)
                    .map(([key, value]) => ({ date: key, amount: value }))
                    .sort((a, b) => a.date.localeCompare(b.date));
            }, [debts]);

            // --- ACTIONS ---
            // Helper to add item to cart
            const handleAddItem = () => {
                if (!lineItem.detail || !lineItem.unitPrice) {
                    addToast('Ingresa detalle y precio', 'error');
                    return;
                }
                const newItem = {
                    detail: lineItem.detail,
                    quantity: parseInt(lineItem.quantity) || 1,
                    unitPrice: parseFloat(lineItem.unitPrice),
                    totalPrice: (parseInt(lineItem.quantity) || 1) * parseFloat(lineItem.unitPrice)
                };

                setForm(prev => ({
                    ...prev,
                    items: [...prev.items, newItem],
                    price: prev.price + newItem.totalPrice
                }));
                setLineItem({ detail: '', quantity: 1, unitPrice: '' });
            };

            const handleRemoveItem = (index) => {
                const itemToRemove = form.items[index];
                setForm(prev => ({
                    ...prev,
                    items: prev.items.filter((_, i) => i !== index),
                    price: prev.price - itemToRemove.totalPrice
                }));
            };

            const handleSaveOrder = async (e) => {
                e.preventDefault();
                if (isSaving) return;
                
                // Si no hay items en el carrito, advertir
                if (form.items.length === 0) { 
                    addToast('Agrega al menos un producto al pedido', 'error'); 
                    return; 
                }
                
                if (!form.client) { 
                    addToast('Selecciona un cliente', 'error'); 
                    return; 
                }
                
                setIsSaving(true);
                const now = new Date();
                const parts = form.date.split('-');
                const selectedDate = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]), 12, 0, 0);

                // Generar resumen automático para 'detail' (backward compatibility y búsquedas)
                const summaryDetail = form.items.map(i => `${i.quantity > 1 ? i.quantity + 'x ' : ''}${i.detail}`).join(', ');

                const orderData = {
                    client: form.client,
                    detail: summaryDetail, // Autogenerated summary
                    items: form.items, // New structure
                    price: parseFloat(form.price), 
                    quantity: form.items.reduce((acc, i) => acc + i.quantity, 0), // Total quantity
                    paid: form.paid, 
                    paymentMethod: form.paid ? (form.paymentMethod || 'cash') : null,
                    paymentDate: form.paid ? (form.paymentDate || selectedDate.toISOString()) : null,
                    delivered: form.delivered, 
                    deliveryDate: form.delivered ? (form.deliveryDate || selectedDate.toISOString()) : null,
                    important: form.important, 
                    date: selectedDate.toISOString(),
                    category: identifyCategory(summaryDetail)
                };

                try {
                    if (editingId) {
                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', editingId), orderData);
                        addToast('Pedido actualizado');
                    } else {
                        orderData.createdAt = new Date().toISOString();
                        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'orders'), orderData);
                        addToast('Pedido creado');
                        
                        const clientExists = clients.some(c => c.name.toLowerCase() === form.client.toLowerCase());
                        if (!clientExists) {
                            setClientPromptData(form.client);
                            setConfirmModal({
                                isOpen: true, title: 'Cliente Nuevo', 
                                message: `El cliente "${form.client}" no figura en la base de datos. ¿Deseas agregarlo?`,
                                onConfirm: () => {
                                    setClientForm({ name: form.client, phone: '', email: '', address: '', notes: '' });
                                    setEditingClientId(null);
                                    setIsClientModalOpen(true);
                                },
                                isDanger: false,
                                confirmText: "Agregar Cliente"
                            });
                        }
                    }
                    setIsModalOpen(false);
                } catch (err) { console.error(err); addToast('Error al guardar', 'error'); } 
                finally { setIsSaving(false); }
            };
            
            // Function to load order into edit mode (handling legacy format)
            const openEditModal = (order) => {
                setEditingId(order.id);
                
                // Comprobar si es un pedido antiguo (sin items) o nuevo
                if (order.items && Array.isArray(order.items)) {
                    setForm(order);
                } else {
                    // Convertir pedido antiguo a formato nuevo para edición
                    setForm({
                        ...order,
                        items: [{
                            detail: order.detail,
                            quantity: order.quantity || 1,
                            unitPrice: order.price / (order.quantity || 1),
                            totalPrice: order.price
                        }]
                    });
                }
                
                setLineItem({ detail: '', quantity: 1, unitPrice: '' });
                setIsModalOpen(true);
            };

            const handleDeleteOrder = (id) => {
                setConfirmModal({
                    isOpen: true, title: 'Eliminar Pedido', message: '¿Estás seguro? Esta acción es irreversible.', isDanger: true, confirmText: 'Eliminar',
                    onConfirm: async () => {
                        try { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', id)); addToast('Pedido eliminado'); }
                        catch(e) { addToast('Error', 'error'); }
                    }
                });
            };

   const toggleStatus = async (order, field) => {
                const updates = {};
                if (field === 'paid') {
                    if (!order.paid) { 
                        setPendingPaymentId(order.id); setPaymentModalStep('select'); setMixedAmounts({cash:'', transfer: order.price}); setIsPaymentModalOpen(true); return;
                    } else { updates.paid = false; updates.paymentDate = null; updates.paymentDetails = null; }
                } else if (field === 'delivered') {
                    if (!order.delivered) { 
                        setPendingDeliveryId(order.id); setDeliveryDateInput(new Date().toISOString().slice(0, 16)); setIsDeliveryModalOpen(true); return;
                    } else { updates.delivered = false; updates.deliveryDate = null; }
                } else if (field === 'done') {
                    // --- LÓGICA DE HECHO ---
                    if (!order.done) { 
                        setPendingDoneId(order.id); 
                        setDoneDateInput(new Date().toISOString().slice(0, 16)); 
                        setIsDoneModalOpen(true); 
                        return;
                    } else { 
                        updates.done = false; 
                        updates.doneDate = null; 
                    }
                    // -----------------------
                } else { updates[field] = !order[field]; }
                
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', order.id), updates);
            };

  const handleConfirmPayment = async (method) => {
                const order = orders.find(o => o.id === pendingPaymentId);
                
                // Validación de seguridad
                if (!order || order.price <= 0) {
                    addToast('❌ No se puede cobrar un pedido con monto $0', 'error');
                    return;
                }

                const now = new Date().toISOString();
                let newHistoryItem = { date: now, method: method };
                let isFullPayment = false;
                let finalUpdates = {};

                // --- CASO 1: PAGO PARCIAL ---
                if (method === 'partial') {
                    const amount = parseFloat(partialAmount);
                    if (!amount || amount <= 0) { addToast('Ingresa un monto válido', 'error'); return; }
                    
                    const currentPaid = order.amountPaid || 0;
                    const remaining = order.price - currentPaid;

                    // Evitar cobrar más de lo que se debe
                    if (amount > remaining) { addToast(`El monto excede la deuda ($${remaining})`, 'error'); return; }

                    newHistoryItem.amount = amount;
                    newHistoryItem.method = partialMethod; // <--- AQUÍ ESTÁ EL CAMBIO
                    newHistoryItem.isPartial = true;

                    const totalPaidNow = currentPaid + amount;
                    
                    finalUpdates = {
                        amountPaid: totalPaidNow,
                        paymentHistory: [...(order.paymentHistory || []), newHistoryItem]
                    };

                    // Si con este pago completa el total (con un margen de error de $1), marcamos como pagado
                    if (totalPaidNow >= order.price - 1) { 
                        isFullPayment = true;
                        finalUpdates.paid = true;
                        finalUpdates.paymentDate = now;
                        finalUpdates.paymentMethod = 'history'; 
                    }

                } else {
                    // --- CASO 2: PAGO TOTAL (Efectivo / Digital / Mixto) ---
                    isFullPayment = true;
                    const remaining = order.price - (order.amountPaid || 0);
                    
                    if (method === 'mixed') {
                        const cash = parseFloat(mixedAmounts.cash) || 0;
                        const transfer = parseFloat(mixedAmounts.transfer) || 0;
                        
                        // Validación: la suma debe coincidir con lo que falta pagar
                        if (Math.abs((cash + transfer) - remaining) > 1) { 
                             addToast('La suma no coincide con el restante', 'error');
                             return;
                        }
                        newHistoryItem.amount = remaining;
                        newHistoryItem.paymentDetails = { cash, transfer };
                    } else {
                        newHistoryItem.amount = remaining;
                    }
                    
                    finalUpdates = {
                        paid: true,
                        paymentMethod: method,
                        paymentDate: now,
                        paymentDetails: method === 'mixed' ? { cash: parseFloat(mixedAmounts.cash), transfer: parseFloat(mixedAmounts.transfer) } : null,
                        amountPaid: order.price, // Se asume pagado total
                        paymentHistory: [...(order.paymentHistory || []), newHistoryItem]
                    };
                }

                try {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', pendingPaymentId), finalUpdates);
                    setIsPaymentModalOpen(false);
                    setPartialAmount(''); // Limpiar el campo
                    addToast(isFullPayment ? '¡Pedido pagado totalmente!' : 'Pago parcial registrado');
                } catch (error) {
                    console.error(error);
                    addToast('Error al registrar el cobro', 'error');
                }
            };
            const handleDeliveryConfirm = async () => {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', pendingDeliveryId), { 
                    delivered: true, deliveryDate: deliveryDateInput ? new Date(deliveryDateInput).toISOString() : new Date().toISOString() 
                });
                setIsDeliveryModalOpen(false);
                addToast('Entrega registrada');
            };

const handleDoneConfirm = async () => {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', pendingDoneId), { 
                    done: true, 
                    doneDate: doneDateInput ? new Date(doneDateInput).toISOString() : new Date().toISOString() 
                });
                setIsDoneModalOpen(false);
                addToast('Pedido marcado como realizado');
            };

            const handleSimpleSave = async (coll, data, setModal, cleanForm, defaultForm, id = null) => {
                setIsSaving(true);
                try {
                    if (id) {
                         await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', coll, id), data);
                    } else {
                         const docData = { ...data, createdAt: new Date().toISOString() };
                         await addDoc(collection(db, 'artifacts', appId, 'public', 'data', coll), docData);
                    }
                    addToast('Registrado correctamente');
                    setModal(false); cleanForm(defaultForm);
                } catch(e) { addToast('Error', 'error'); }
                finally { setIsSaving(false); }
            };

            const handleSaveDebt = async (e) => {
                e.preventDefault();
                setIsSaving(true);
                try {
                    const batch = writeBatch(db);
                    const collectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'debts');

                    if (debtForm.mode === 'single') {
                         const docRef = doc(collectionRef);
                         batch.set(docRef, {
                             detail: debtForm.detail,
                             amount: parseFloat(debtForm.amount),
                             date: new Date().toISOString(),
                             paid: false,
                             createdAt: new Date().toISOString()
                         });
                    } else if (debtForm.mode === 'installments') {
                        // Create N documents starting from startMonth
                        const [yearStr, monthStr] = debtForm.startMonth.split('-');
                        const start = new Date(parseInt(yearStr), parseInt(monthStr) - 1, 5); // Use 5th to be safe
                        
                        for (let i = 0; i < parseInt(debtForm.quotaCount); i++) {
                            const docRef = doc(collectionRef);
                            const d = new Date(start);
                            d.setMonth(d.getMonth() + i);
                            
                            batch.set(docRef, {
                                detail: `${debtForm.detail} (Cuota ${i+1}/${debtForm.quotaCount})`,
                                amount: parseFloat(debtForm.amount),
                                date: d.toISOString(),
                                paid: false,
                                createdAt: new Date().toISOString()
                            });
                        }
                    } else if (debtForm.mode === 'fixed') {
                         const year = parseInt(debtForm.year);
                         for (let i = 0; i < 12; i++) {
                             const docRef = doc(collectionRef);
                             const d = new Date(year, i, 5);
                             const monthName = new Intl.DateTimeFormat('es-AR', { month: 'long' }).format(d);
                             const capitalMonth = monthName.charAt(0).toUpperCase() + monthName.slice(1);
                             
                             batch.set(docRef, {
                                detail: `${debtForm.detail} (${capitalMonth})`,
                                amount: parseFloat(debtForm.amount),
                                date: d.toISOString(),
                                paid: false,
                                createdAt: new Date().toISOString()
                            });
                         }
                    }

                    await batch.commit();
                    addToast('Deuda(s) registrada(s) correctamente');
                    setIsDebtModalOpen(false);
                    setDebtForm({ mode: 'single', detail: '', amount: '', quotaCount: 1, startMonth: new Date().toISOString().slice(0, 7), year: new Date().getFullYear() });
                } catch (error) {
                    console.error(error);
                    addToast('Error al guardar', 'error');
                } finally {
                    setIsSaving(false);
                }
            };

            const handleDelete = async (coll, id) => {
                setConfirmModal({
                    isOpen: true, title: 'Eliminar Registro', message: '¿Estás seguro?', isDanger: true, confirmText: 'Eliminar',
                    onConfirm: async () => {
                        try { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', coll, id)); addToast('Eliminado'); } catch(e) { addToast('Error', 'error'); }
                    }
                });
            };

            // MODIFICADO: Funciones para editar finanzas y soportar mixto
            const handleEditFinance = (item) => {
                // LÓGICA DE SEGURIDAD PARA PEDIDOS
                if (item.source === 'orders') {
                    addToast('Para editar un cobro de pedido, elimínalo (tacho rojo) y cárgalo nuevamente.', 'info');
                    return;
                }

                // LÓGICA NORMAL PARA GASTOS E INGRESOS EXTRA
                const isExp = item.source === 'expenses';
                const formSetter = isExp ? setExpenseForm : setIncomeForm;
                const modalSetter = isExp ? setIsExpenseModalOpen : setIsIncomeModalOpen;
                
                const pDetails = item.paymentDetails || { cash: '', transfer: '' };
                const method = item.paymentMethod || item.method || 'cash';
                
                formSetter({ 
                    description: item.desc || item.description, 
                    amount: item.amount, 
                    method: method,
                    mixedCash: pDetails.cash || '',
                    mixedTransfer: pDetails.transfer || '',
                    date: item.date 
                });
                setEditingFinanceId(item.id);
                modalSetter(true);
            };

    const handleDeleteFinance = (item) => {
                // 1. Si es Gasto o Ingreso Extra (fácil)
                if (item.source === 'expenses') { handleDelete('expenses', item.id); return; }
                if (item.source === 'extra_incomes') { handleDelete('extra_incomes', item.id); return; }

                // 2. Si es un Pago de Pedido (complejo)
                if (item.source === 'orders') {
                    setConfirmModal({
                        isOpen: true, 
                        title: 'Eliminar Pago', 
                        message: 'Se eliminará este pago y el saldo volverá a sumarse a la deuda del pedido. ¿Confirmar?', 
                        isDanger: true, 
                        confirmText: 'Eliminar Pago',
                        onConfirm: async () => {
                            try {
                                // Detectar si es un pago del historial nuevo (tiene ID compuesto con _pay_)
                                const isHistoryItem = item.id.includes('_pay_');
                                const realOrderId = isHistoryItem ? item.id.split('_pay_')[0] : item.id;
                                const order = orders.find(o => o.id === realOrderId);
                                
                                if (!order) { addToast('Pedido no encontrado', 'error'); return; }

                                let updates = {};

                                if (isHistoryItem) {
                                    // Es un pago parcial o total del sistema nuevo
                                    const index = parseInt(item.id.split('_pay_')[1]);
                                    
                                    // Filtramos el historial para quitar SOLO este pago
                                    const newHistory = order.paymentHistory.filter((_, i) => i !== index);
                                    
                                    // Recalculamos cuánto se pagó en total sumando lo que queda
                                    const newTotalPaid = newHistory.reduce((acc, curr) => acc + curr.amount, 0);

                                    // Definimos si sigue pagado o no (con margen de error de $1 por decimales)
                                    const isStillPaid = newTotalPaid >= (order.price - 1);

                                    updates = {
                                        paymentHistory: newHistory,
                                        amountPaid: newTotalPaid,
                                        paid: isStillPaid,
                                        // Si al borrar deja de estar pagado, limpiamos fecha y metodo principal
                                        paymentDate: isStillPaid ? order.paymentDate : null, 
                                        paymentMethod: isStillPaid ? 'history' : null
                                    };
                                } else {
                                    // Es un pago del sistema antiguo (sin historial)
                                    updates = {
                                        paid: false,
                                        amountPaid: 0,
                                        paymentDate: null,
                                        paymentMethod: null,
                                        paymentDetails: null,
                                        paymentHistory: []
                                    };
                                }

                                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', realOrderId), updates);
                                addToast('Pago eliminado. Deuda actualizada.');
                            } catch (e) {
                                console.error(e);
                                addToast('Error al eliminar pago', 'error');
                            }
                        }
                    });
                }
            };

            // Función Helper para guardar finanzas con lógica de pago mixto
            const prepareFinanceData = (form) => {
                const data = {
                    description: form.description,
                    amount: parseFloat(form.amount),
                    date: form.date,
                    method: form.method, // Mantener para compatibilidad
                    paymentMethod: form.method // Estandarizar
                };
                if (form.method === 'mixed') {
                    data.paymentDetails = {
                        cash: parseFloat(form.mixedCash) || 0,
                        transfer: parseFloat(form.mixedTransfer) || 0
                    };
                }
                return data;
            };

            if (!isConfigured) return <ConfigErrorScreen />;
            if (isLocked) return <LoginScreen onLogin={handleLogin} credentials={credentials} />;

            return (
                <div className="h-full w-full flex flex-col md:flex-row bg-[#f5f5f4] text-stone-800 overflow-hidden">
                    {/* Toasts */}
                    {toasts.map(t => <Toast key={t.id} message={t.message} type={t.type} onClose={() => removeToast(t.id)} />)}

                    {/* --- SIDEBAR (PC) --- */}
                    <aside className="hidden md:flex flex-col w-72 bg-[#0c0a09] border-r border-stone-800 h-full shrink-0 z-20 shadow-xl">
                        <div className="p-8 flex items-center gap-4">
                            <div className="bg-gradient-to-br from-amber-500 to-amber-600 text-white p-2.5 rounded-xl shadow-lg shadow-amber-900/40">
                                <BrandIcon size={28} />
                            </div>
                            <div>
                                <h1 className="text-2xl font-bold text-white tracking-wide brand-font">OSIRIS</h1>
                                <p className="text-[10px] text-stone-500 uppercase tracking-widest font-semibold mt-0.5">Manager</p>
                            </div>
                        </div>

                        <nav className="flex-1 px-4 space-y-2 overflow-y-auto sidebar-scrollbar py-6">
                            {[
                                { id: 'orders', icon: Home, label: 'Pedidos' },
                                { id: 'clients', icon: Users, label: 'Clientes' },
                                { id: 'suppliers', icon: Truck, label: 'Proveedores' },
                                { id: 'debts', icon: Receipt, label: 'Deudas' },
                                { id: 'finances', icon: Wallet, label: 'Finanzas' },
                                { id: 'stats', icon: BarChart3, label: 'Estadísticas' },
                            ].map(item => (
                                <button key={item.id} onClick={() => setActiveTab(item.id)} 
                                    className={`w-full flex items-center gap-4 px-5 py-3.5 rounded-xl transition-all font-medium text-sm tracking-wide ${activeTab === item.id ? 'bg-stone-800 text-white shadow-inner' : 'text-stone-500 hover:text-stone-300 hover:bg-stone-900/50'}`}>
                                    <item.icon size={20} strokeWidth={activeTab === item.id ? 2 : 1.5} /> {item.label}
                                </button>
                            ))}
                        </nav>

                        <div className="p-6 border-t border-stone-800">
                            <button onClick={() => { setEditingId(null); setForm({ client: '', items: [], price: 0, paid: false, delivered: false, important: false, date: new Date().toISOString().split('T')[0] }); setIsModalOpen(true); }} 
                                className="w-full bg-gradient-to-r from-amber-600 to-amber-700 hover:from-amber-500 hover:to-amber-600 text-white py-4 rounded-xl font-bold shadow-lg shadow-amber-900/20 active:scale-95 transition-all flex items-center justify-center gap-2 mb-4 group">
                                <Plus size={20} className="group-hover:rotate-90 transition-transform duration-300" /> Nuevo Pedido
                            </button>
                            <div className="flex justify-between items-center text-stone-500 mb-4">
                                <button onClick={() => { setTempCredentials({...credentials}); setIsSettingsOpen(true); }} className="p-2 hover:text-white hover:bg-stone-800 rounded-lg transition-colors"><Settings size={18} /></button>
                                <button onClick={handleLogout} className="p-2 hover:text-red-400 hover:bg-stone-800 rounded-lg transition-colors"><LogOut size={18} /></button>
                            </div>
                             {/* FIRMA SIDEBAR */}
                            <div className="text-center pt-2 border-t border-stone-800/50">
                                <p className="text-[9px] text-stone-600 hover:text-stone-50 cursor-default transition-colors">Powered by JA<br/>Javier Amado • javieramado91@gmail.com</p>
                            </div>
                        </div>
                    </aside>

                    {/* --- MAIN CONTENT --- */}
                    <main className="flex-1 flex flex-col h-full overflow-hidden relative">
                        {/* Top Bar Mobile */}
                        <div className="md:hidden bg-[#0c0a09] p-4 flex justify-between items-center shrink-0 z-30">
                            <div className="flex items-center gap-3">
                                <BrandIcon size={24} className="text-amber-500" />
                                <span className="text-white font-bold text-lg brand-font tracking-wide">OSIRIS</span>
                            </div>
                            <button onClick={() => { setEditingId(null); setForm({ client: '', items: [], price: 0, paid: false, delivered: false, important: false, date: new Date().toISOString().split('T')[0] }); setIsModalOpen(true); }} className="bg-amber-600 text-white p-2 rounded-lg shadow-lg active:scale-95 transition-transform"><Plus size={24}/></button>
                        </div>

                        <div className="flex-1 overflow-y-auto custom-scrollbar p-4 md:p-8 md:max-w-7xl md:mx-auto w-full pb-24 md:pb-8">
                            
                            {/* Header Section */}
                            <div className="flex flex-col md:flex-row justify-between items-start md:items-end mb-8 gap-4 animate-in fade-in slide-in-from-top-4 duration-500">
                                <div>
                                    <h2 className="text-2xl md:text-3xl font-bold text-stone-900 brand-font">Vestite para ganar.</h2>
                                    <p className="text-stone-500 mt-1 flex items-center gap-2 text-sm"><Calendar size={14}/> {capitalizedMonth}</p>
                                </div>
                                {activeTab === 'orders' && (
                                <div className="flex items-center bg-white p-1.5 rounded-xl shadow-sm border border-stone-200">
                                    <button onClick={() => changeMonth(-1)} className="p-2 hover:bg-stone-100 rounded-lg text-stone-400 hover:text-stone-800 transition-colors"><ChevronLeft size={20}/></button>
                                    <div className="w-px h-6 bg-stone-200 mx-1"></div>
                                    <button onClick={() => changeMonth(1)} className="p-2 hover:bg-stone-100 rounded-lg text-stone-400 hover:text-stone-800 transition-colors"><ChevronRight size={20}/></button>
                                </div>
                                )}
                            </div>

                           {activeTab === 'orders' && (
                                <div className="space-y-6 animate-in fade-in duration-300">
                                    {/* Stats Cards - ACTUALIZADO A 5 COLUMNAS */}
                                    <div className="grid grid-cols-2 md:grid-cols-5 gap-3 md:gap-4">
                                        <div className="bg-white p-4 md:p-5 rounded-2xl border border-stone-100 shadow-sm">
                                            <p className="text-[10px] text-stone-400 font-bold uppercase tracking-wider mb-1">Ventas Totales</p>
                                            <p className="text-xl md:text-2xl font-bold text-stone-900">${filteredOrders.reduce((acc,o) => acc + o.price, 0).toLocaleString()}</p>
                                        </div>

                                        {/* NUEVA TARJETA: POR HACER */}
                                        <div className="bg-white p-4 md:p-5 rounded-2xl border border-stone-100 shadow-sm">
                                            <p className="text-[10px] text-stone-400 font-bold uppercase tracking-wider mb-1">Por Hacer</p>
                                            <p className="text-xl md:text-2xl font-bold text-purple-600">{filteredOrders.filter(o=>!o.done).length}</p>
                                        </div>

                                        <div className="bg-white p-4 md:p-5 rounded-2xl border border-stone-100 shadow-sm">
                                            <p className="text-[10px] text-stone-400 font-bold uppercase tracking-wider mb-1">Por Cobrar</p>
                                            <p className="text-xl md:text-2xl font-bold text-amber-600">${filteredOrders.filter(o=>!o.paid).reduce((acc,o) => acc + o.price, 0).toLocaleString()}</p>
                                        </div>
                                        <div className="bg-white p-4 md:p-5 rounded-2xl border border-stone-100 shadow-sm">
                                            <p className="text-[10px] text-stone-400 font-bold uppercase tracking-wider mb-1">Pendiente Entrega</p>
                                            <p className="text-xl md:text-2xl font-bold text-stone-800">{filteredOrders.filter(o=>!o.delivered).length}</p>
                                        </div>
                                        <div className="bg-stone-900 p-4 md:p-5 rounded-2xl shadow-lg text-white relative overflow-hidden hidden md:block">
                                            <div className="absolute right-0 top-0 opacity-10 p-2"><Award size={48}/></div>
                                            <p className="text-[10px] text-stone-400 font-bold uppercase tracking-wider mb-1">Ticket Promedio</p>
                                            <p className="text-xl md:text-2xl font-bold text-amber-400">${filteredOrders.length > 0 ? Math.round(filteredOrders.reduce((acc,o) => acc + o.price, 0) / filteredOrders.length).toLocaleString() : 0}</p>
                                        </div>
                                    </div>

                                    {/* Filters - ACTUALIZADO CON BOTÓN "POR HACER" */}
                                    <div className="flex flex-col md:flex-row gap-4">
                                        <div className="relative flex-1">
                                            <Search className="absolute left-4 top-1/2 -translate-y-1/2 text-stone-400" size={18} />
                                            <input type="text" placeholder="Buscar cliente, prenda..." className="w-full pl-11 pr-4 py-3 bg-white border border-stone-200 rounded-xl focus:ring-2 focus:ring-amber-500/20 focus:border-amber-500 outline-none text-sm font-medium" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />
                                        </div>
                                        <div className="flex gap-2 overflow-x-auto pb-1 no-scrollbar">
                                        {['all', 'todo', 'pending_pay', 'done', 'pending_delivery', 'delivered', 'important'].map(f => (
                                                <button key={f} onClick={() => setOrderFilter(f)} className={`px-4 py-2.5 rounded-xl text-xs font-bold whitespace-nowrap transition-all border ${orderFilter === f ? 'bg-stone-900 text-white border-stone-900 shadow-md' : 'bg-white text-stone-500 border-stone-200 hover:bg-stone-50'}`}>
                                                    {f === 'all' && 'Todos'}
                                                    {f === 'todo' && 'Por Hacer'}
                                                    {f === 'pending_pay' && 'Por Cobrar'}
                                                    {f === 'done' && 'Realizados'}
                                                    {f === 'pending_delivery' && 'En Local'}
                                                    {f === 'delivered' && 'Entregados'}
                                                    {f === 'important' && 'Favoritos'}
                                                </button>
                                            ))}
                                        </div>
                                    </div>

                                    {/* List */}
                                    <div className="space-y-3">
                                        {filteredOrders.length === 0 ? 
                                            <div className="text-center py-20 bg-white rounded-3xl border border-dashed border-stone-200">
                                                <ShoppingBag className="mx-auto text-stone-200 mb-4" size={48} />
                                                <p className="text-stone-400">No se encontraron pedidos</p>
                                            </div> 
                                        : filteredOrders.map(order => (
                                            <div key={order.id} className={`bg-white p-5 rounded-2xl border transition-all hover:shadow-lg group ${order.important ? 'border-amber-200 bg-amber-50/10' : 'border-stone-100'}`}>
                                                <div className="flex justify-between items-start mb-3">
                                                    <div className="flex items-center gap-4">
                                                        <SmartIcon iconName={getSmartIconName(order.detail)} color={generateColorFromText(order.detail)} />
                                                        <div>
                                                            <div className="flex items-center gap-2">
                                                                <h3 className="font-bold text-stone-900 text-lg leading-tight">{order.client}</h3>
                                                                {order.quantity > 1 && <span className="bg-stone-100 text-stone-600 text-[10px] font-bold px-1.5 py-0.5 rounded">x{order.quantity} unid.</span>}
                                                            </div>
                                                            <p className="text-xs text-stone-400 uppercase tracking-wide mt-0.5">{new Date(order.date).toLocaleDateString()}</p>
                                                        </div>
                                                    </div>
                                                    <div className="flex gap-2">
                                                        <button onClick={() => toggleStatus(order, 'important')} className={`p-2 rounded-lg transition-colors ${order.important ? 'text-amber-500 bg-amber-50' : 'text-stone-300 hover:bg-stone-50'}`}><Star size={18} fill={order.important ? "currentColor" : "none"} /></button>
                                                        <button onClick={() => openEditModal(order)} className="p-2 text-stone-300 hover:text-stone-800 hover:bg-stone-50 rounded-lg"><Pencil size={18} /></button>
                                                    </div>
                                                </div>
                                                
                                                <div className="pl-[4.5rem]">
                                                    <p className="text-stone-600 text-sm mb-4 font-medium">{order.detail}</p>
                                                    
                                                    {/* --- NUEVO: BARRA DE PROGRESO DE PAGO --- */}
                                                    {(!order.paid && order.amountPaid > 0) && (
                                                        <div className="mb-4 bg-stone-50 p-3 rounded-xl border border-stone-100">
                                                            <div className="flex justify-between items-end mb-1">
                                                                <span className="text-xs font-bold text-stone-500">Abonado: <span className="text-emerald-600">${order.amountPaid.toLocaleString()}</span></span>
                                                                <span className="text-xs font-bold text-red-500">Resta: ${(order.price - order.amountPaid).toLocaleString()}</span>
                                                            </div>
                                                            <div className="w-full h-2 bg-stone-200 rounded-full overflow-hidden">
                                                                <div className="h-full bg-emerald-500 rounded-full transition-all duration-500" style={{ width: `${(order.amountPaid / order.price) * 100}%` }}></div>
                                                            </div>
                                                        </div>
                                                    )}
                                                    {/* ---------------------------------------- */}

                                                    <div className="flex flex-wrap items-center justify-between gap-4 pt-3 border-t border-stone-50">
                                                        <div className="flex items-center gap-2">
                                                            <span className="text-xl font-bold text-stone-900 brand-font">${order.price.toLocaleString()}</span>
                                                            {order.paymentMethod && (
                                                                <span className={`text-[10px] font-bold uppercase px-2 py-1 rounded-md bg-stone-100 text-stone-500 flex items-center gap-1`}>
                                                                    {order.paymentMethod === 'cash' ? <Banknote size={10} /> : <CreditCard size={10} />}
                                                                    {order.paymentMethod === 'mixed' ? 'Mixto' : (order.paymentMethod === 'history' ? 'Parciales' : (order.paymentMethod === 'cash' ? 'Efectivo' : 'Transf.'))}
                                                                </span>
                                                            )}
                                                        </div>
                                                        <div className="flex gap-2">
                                                            {/* Botón de Cobrar actualizado */}
                                                            <button onClick={() => toggleStatus(order, 'paid')} className={`px-3 py-1.5 rounded-lg text-xs font-bold flex items-center gap-1.5 transition-colors border ${order.paid ? 'bg-emerald-50 text-emerald-700 border-emerald-100' : (order.amountPaid > 0 ? 'bg-amber-50 text-amber-700 border-amber-200' : 'bg-white text-stone-400 border-stone-200 hover:border-stone-300')}`}>
                                                                {order.paid ? <CheckCircle2 size={14}/> : <Circle size={14}/>} 
                                                                {order.paid ? 'Pagado' : (order.amountPaid > 0 ? 'Resto' : 'Cobrar')}
                                                            </button>

                                                            <button onClick={() => toggleStatus(order, 'done')} className={`px-3 py-1.5 rounded-lg text-xs font-bold flex items-center gap-1.5 transition-colors border ${order.done ? 'bg-purple-50 text-purple-700 border-purple-100' : 'bg-white text-stone-400 border-stone-200 hover:border-stone-300'}`}>
                                                                <Scissors size={14}/> {order.done ? 'Hecho' : 'Hacer'}
                                                            </button>

                                                            <button onClick={() => toggleStatus(order, 'delivered')} className={`px-3 py-1.5 rounded-lg text-xs font-bold flex items-center gap-1.5 transition-colors border ${order.delivered ? 'bg-blue-50 text-blue-700 border-blue-100' : 'bg-white text-stone-400 border-stone-200 hover:border-stone-300'}`}>
                                                                <Truck size={14}/> {order.delivered ? 'Entregado' : 'Entregar'}
                                                            </button>
                                                            <button onClick={() => handleDeleteOrder(order.id)} className="p-1.5 text-stone-300 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors ml-1"><Trash2 size={16}/></button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {activeTab === 'clients' && (
                                <div className="space-y-6 animate-in fade-in slide-in-from-right-4 duration-300">
                                    <div className="flex justify-between items-center">
                                        <div><h3 className="font-bold text-xl brand-font">Cartera de Clientes</h3><p className="text-sm text-stone-500">Gestión de fidelidad</p></div>
                                        <div className="flex gap-2">
                                            <button onClick={() => setIsClientStatsModalOpen(true)} className="bg-white border border-stone-200 text-stone-600 px-4 py-2 rounded-xl text-sm font-bold flex items-center gap-2 hover:bg-stone-50 hover:text-stone-800"><BarChart3 size={16}/> <span className="hidden md:inline">Estadísticas</span></button>
                                            <button onClick={() => { setEditingClientId(null); setClientForm({name:'', phone:'', email:'', address:'', notes:''}); setIsClientModalOpen(true); }} className="bg-stone-900 text-white px-4 py-2 rounded-xl text-sm font-bold flex items-center gap-2 hover:bg-stone-800 shadow-lg shadow-stone-900/10"><Plus size={16}/> <span className="hidden md:inline">Nuevo Cliente</span></button>
                                        </div>
                                    </div>
                                    
                                    <div className="flex gap-4">
                                        <div className="relative flex-1">
                                            <Search className="absolute left-4 top-1/2 -translate-y-1/2 text-stone-400" size={18} />
                                            <input type="text" placeholder="Buscar cliente..." className="w-full pl-11 pr-4 py-3 bg-white border border-stone-200 rounded-xl focus:ring-2 focus:ring-amber-500/20 focus:border-amber-500 outline-none text-sm font-medium" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />
                                        </div>
                                        <select className="bg-white border border-stone-200 rounded-xl px-4 text-sm font-medium text-stone-600 outline-none" value={clientSort} onChange={e => setClientSort(e.target.value)}>
                                            <option value="name">Nombre A-Z</option>
                                            <option value="spent">Mayor Consumo</option>
                                            <option value="debt">Mayor Deuda</option>
                                        </select>
                                    </div>

                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                        {sortedClients.map(c => (
                                            <div key={c.id} className="bg-white p-5 rounded-2xl border border-stone-100 shadow-sm hover:shadow-md transition-shadow">
                                                <div className="flex justify-between items-start mb-4">
                                                    <div className="flex items-center gap-3">
                                                        <div className="w-10 h-10 rounded-full bg-amber-100 flex items-center justify-center text-amber-700 font-bold">{c.name.charAt(0)}</div>
                                                        <div>
                                                            <h4 className="font-bold text-stone-900">{c.name}</h4>
                                                            <p className="text-xs text-stone-400">{c.phone || 'Sin teléfono'}</p>
                                                        </div>
                                                    </div>
                                                    <div className="flex gap-1">
                                                        <button onClick={() => { setEditingClientId(c.id); setClientForm(c); setIsClientModalOpen(true); }} className="p-1.5 text-stone-400 hover:text-stone-800 hover:bg-stone-50 rounded-lg"><Pencil size={16}/></button>
                                                        <button onClick={() => handleDelete('clients', c.id)} className="p-1.5 text-stone-400 hover:text-red-500 hover:bg-red-50 rounded-lg"><Trash2 size={16}/></button>
                                                    </div>
                                                </div>
                                                
                                                <div className="grid grid-cols-2 gap-2 text-center text-xs bg-stone-50 rounded-lg p-3">
                                                    <div>
                                                        <p className="text-stone-400 mb-1">Gastado</p>
                                                        <p className="font-bold text-emerald-600 text-sm">${c.stats.spent.toLocaleString()}</p>
                                                    </div>
                                                    <div className="border-l border-stone-200">
                                                        <p className="text-stone-400 mb-1">Deuda</p>
                                                        <p className={`font-bold text-sm ${c.stats.debt > 0 ? 'text-red-500' : 'text-stone-600'}`}>${c.stats.debt.toLocaleString()}</p>
                                                    </div>
                                                </div>
                                                <div className="mt-3 flex justify-between items-center text-xs text-stone-500">
                                                    <span className="flex items-center gap-1"><Tag size={12}/> Favorito: {c.stats.topCategory}</span>
                                                    <span>{c.stats.orderCount} compras</span>
                                                </div>
                                            </div>
                                        ))}
                                        {sortedClients.length === 0 && <div className="col-span-full py-12 text-center text-stone-400">No hay clientes registrados</div>}
                                    </div>
                                </div>
                            )}

                            {activeTab === 'suppliers' && (
                                <div className="space-y-6 animate-in fade-in slide-in-from-right-4 duration-300">
                                     <div className="flex justify-between items-center">
                                        <div><h3 className="font-bold text-xl brand-font">Proveedores</h3><p className="text-sm text-stone-500">Logística y stock</p></div>
                                        <button onClick={() => { setEditingSupplierId(null); setSupplierForm({name:'', cuit:'', phone:'', address:'', products:'', notes:''}); setIsSupplierModalOpen(true); }} className="bg-stone-900 text-white px-4 py-2 rounded-xl text-sm font-bold flex items-center gap-2 hover:bg-stone-800 shadow-lg shadow-stone-900/10"><Plus size={16}/> <span className="hidden md:inline">Nuevo Proveedor</span></button>
                                    </div>

                                    {/* Lista de Proveedores */}
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                        {suppliers.map(s => (
                                            <div key={s.id} className="bg-white p-5 rounded-2xl border border-stone-100 shadow-sm hover:shadow-md transition-shadow relative overflow-hidden group">
                                                <div className="absolute right-0 top-0 p-10 opacity-5"><Truck size={100}/></div>
                                                <div className="relative z-10">
                                                    <div className="flex justify-between items-start mb-2">
                                                        <h4 className="font-bold text-lg text-stone-900">{s.name}</h4>
                                                        <div className="flex gap-1">
                                                            <button onClick={() => { setEditingSupplierId(s.id); setSupplierForm(s); setIsSupplierModalOpen(true); }} className="p-1.5 text-stone-400 hover:text-stone-800 hover:bg-stone-50 rounded-lg"><Pencil size={16}/></button>
                                                            <button onClick={() => handleDelete('suppliers', s.id)} className="p-1.5 text-stone-400 hover:text-red-500 hover:bg-red-50 rounded-lg"><Trash2 size={16}/></button>
                                                        </div>
                                                    </div>
                                                    <div className="space-y-1 text-sm text-stone-500 mb-4">
                                                        {s.cuit && <p className="flex items-center gap-2"><FileText size={14}/> {s.cuit}</p>}
                                                        {s.phone && <p className="flex items-center gap-2"><Phone size={14}/> {s.phone}</p>}
                                                        <p className="flex items-center gap-2"><Package size={14}/> {s.products || 'Varios'}</p>
                                                    </div>
                                                    <button onClick={() => { setSupplierOrderForm(prev => ({...prev, supplierId: s.id})); setIsSupplierOrderModalOpen(true); }} className="w-full py-2 bg-stone-100 text-stone-600 rounded-lg text-xs font-bold hover:bg-stone-200 transition-colors">Registrar Compra</button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>

                                    {/* Historial de Pedidos a Proveedores - Tabla PC / Cards Mobile */}
                                    <div className="bg-white rounded-2xl border border-stone-100 shadow-sm overflow-hidden mt-8">
                                        <div className="px-6 py-4 border-b border-stone-50 bg-stone-50/30 flex justify-between items-center">
                                            <h3 className="font-bold text-stone-800 flex items-center gap-2"><ClipboardList size={18}/> Registro de Mercadería</h3>
                                        </div>
                                        
                                        {/* Vista Escritorio: Tabla */}
                                        <div className="hidden md:block overflow-x-auto">
                                            <table className="w-full text-sm">
                                                <thead className="bg-stone-50 text-xs text-stone-500 uppercase font-bold text-left"><tr><th className="px-6 py-3">Fecha</th><th className="px-6 py-3">Proveedor</th><th className="px-6 py-3">Detalle</th><th className="px-6 py-3 text-right">Monto</th><th className="px-6 py-3 text-center">Recibido</th></tr></thead>
                                                <tbody className="divide-y divide-stone-50">
                                                    {supplierOrders.sort((a,b) => new Date(b.date) - new Date(a.date)).map((o, i) => {
                                                        const suppName = suppliers.find(s => s.id === o.supplierId)?.name || 'Desconocido';
                                                        return (
                                                            <tr key={i} className="hover:bg-stone-50/50 transition-colors">
                                                                <td className="px-6 py-3.5 text-stone-500 whitespace-nowrap">{new Date(o.date).toLocaleDateString()}</td>
                                                                <td className="px-6 py-3.5 font-medium text-stone-800">{suppName}</td>
                                                                <td className="px-6 py-3.5 text-stone-600">{o.detail}</td>
                                                                <td className="px-6 py-3.5 text-right font-bold text-stone-800">${parseFloat(o.amount).toLocaleString()}</td>
                                                                <td className="px-6 py-3.5 text-center">
                                                                    <button onClick={() => handleSimpleSave('supplier_orders', { received: !o.received }, () => {}, () => {}, {}, o.id)} className={`p-1 rounded-full ${o.received ? 'bg-emerald-100 text-emerald-600' : 'bg-stone-100 text-stone-300'}`}>
                                                                        {o.received ? <Check size={14}/> : <Circle size={14}/>}
                                                                    </button>
                                                                </td>
                                                            </tr>
                                                        );
                                                    })}
                                                </tbody>
                                            </table>
                                        </div>

                                        {/* Vista Móvil: Cards */}
                                        <div className="md:hidden p-4 space-y-3">
                                            {supplierOrders.sort((a,b) => new Date(b.date) - new Date(a.date)).map((o, i) => {
                                                const suppName = suppliers.find(s => s.id === o.supplierId)?.name || 'Desconocido';
                                                return (
                                                    <div key={i} className="bg-stone-50 p-4 rounded-xl border border-stone-100 flex justify-between items-center">
                                                        <div>
                                                            <div className="flex items-center gap-2">
                                                                <span className="text-xs text-stone-400 font-mono">{new Date(o.date).toLocaleDateString()}</span>
                                                                <span className="text-xs font-bold text-stone-700 bg-white px-2 py-0.5 rounded border border-stone-200">{suppName}</span>
                                                            </div>
                                                            <p className="font-bold text-stone-900 mt-1">{o.detail}</p>
                                                            <p className="text-stone-500 text-sm font-mono mt-0.5">${parseFloat(o.amount).toLocaleString()}</p>
                                                        </div>
                                                        <button onClick={() => handleSimpleSave('supplier_orders', { received: !o.received }, () => {}, () => {}, {}, o.id)} className={`p-2 rounded-full transition-colors ${o.received ? 'bg-emerald-100 text-emerald-600' : 'bg-white border border-stone-200 text-stone-300'}`}>
                                                            {o.received ? <Check size={20}/> : <Circle size={20}/>}
                                                        </button>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                </div>
                            )}

{activeTab === 'finances' && (
    <div className="space-y-6 animate-in fade-in slide-in-from-right-4 duration-300">
        
        {/* LÓGICA DE FILTRADO Y CÁLCULOS DINÁMICOS */}
        {(() => {
            // 1. Filtramos los movimientos según el botón seleccionado
            const filteredMovements = finances.movements.filter(m => {
                if (financeFilter === 'all') return true;
				
				if (financeFilter === 'expenses') return m.type === 'expense';
				
                const method = m.paymentMethod || m.method || 'cash';
                
                if (financeFilter === 'cash') return method === 'cash' || method === 'mixed';
                if (financeFilter === 'transfer') return method === 'transfer' || method === 'mixed';
                if (financeFilter === 'mixed') return method === 'mixed'; // <--- NUEVO FILTRO
                return true;
            });

            // 2. Calculamos el Balance de la VISTA ACTUAL
            const currentViewIncome = filteredMovements
                .filter(m => m.type === 'income')
                .reduce((acc, m) => acc + m.amount, 0);

            const currentViewExpense = filteredMovements
                .filter(m => m.type === 'expense')
                .reduce((acc, m) => acc + m.amount, 0);

            const currentViewNet = currentViewIncome - currentViewExpense;

            // 3. Desglose detallado Efectivo vs Digital (para la tarjeta negra)
            const currentViewCash = filteredMovements.reduce((acc, m) => {
                let val = 0;
                if (m.paymentMethod === 'mixed' && m.paymentDetails) val = parseFloat(m.paymentDetails.cash) || 0;
                else if (m.paymentMethod === 'cash' || !m.paymentMethod) val = m.amount;
                else if (m.paymentMethod === 'transfer') val = 0;
                return m.type === 'income' ? acc + val : acc - val;
            }, 0);

            const currentViewTransfer = filteredMovements.reduce((acc, m) => {
                let val = 0;
                if (m.paymentMethod === 'mixed' && m.paymentDetails) val = parseFloat(m.paymentDetails.transfer) || 0;
                else if (m.paymentMethod === 'transfer') val = m.amount;
                else if (m.paymentMethod === 'cash') val = 0;
                return m.type === 'income' ? acc + val : acc - val;
            }, 0);

            // Determinamos qué valor mostrar en la Tarjeta Negra
            let displayAmount = currentViewNet;
            let displayLabel = 'Mes Actual';

            if (financeFilter === 'cash') {
                displayAmount = currentViewCash;
                displayLabel = 'Efectivo Mes';
            } else if (financeFilter === 'transfer') {
                displayAmount = currentViewTransfer;
                displayLabel = 'Digital Mes';
            } else if (financeFilter === 'mixed') {
                displayAmount = currentViewNet;
                displayLabel = 'Pagos Mixtos';
            }

            return (
                <>
                    {/* TARJETA DE BALANCE DINÁMICA */}
                    <div className="bg-[#0c0a09] text-white p-8 rounded-3xl shadow-2xl relative overflow-hidden transition-all duration-500">
                        <div className="absolute right-0 top-0 p-10 opacity-5"><Wallet size={150}/></div>
                        <div className="relative z-10 flex flex-col md:flex-row justify-between md:items-end gap-6">
                            <div>
                                <p className="text-stone-400 text-xs font-bold uppercase tracking-widest mb-2">
                                    Balance {displayLabel}
                                </p>
                                <h3 className="text-4xl md:text-5xl font-bold brand-font tracking-tight text-white animate-in fade-in">
                                    ${displayAmount.toLocaleString()}
                                </h3>
                                
                                {/* Desglose pequeño (se muestra en Todos o Mixto) */}
                                {(financeFilter === 'all' || financeFilter === 'mixed') && (
                                    <div className="flex gap-4 mt-6">
                                        <div className="flex items-center gap-2"><div className="w-2 h-2 rounded-full bg-emerald-500"></div><span className="text-sm text-stone-300">Efvo: <b>${currentViewCash.toLocaleString()}</b></span></div>
                                        <div className="flex items-center gap-2"><div className="w-2 h-2 rounded-full bg-blue-500"></div><span className="text-sm text-stone-300">Dig: <b>${currentViewTransfer.toLocaleString()}</b></span></div>
                                    </div>
                                )}
                            </div>
                            <div className="flex gap-3 w-full md:w-auto">
                                <button onClick={() => { setEditingFinanceId(null); setIncomeForm({description: '', amount: '', method: 'cash', mixedCash: '', mixedTransfer: '', date: new Date().toISOString()}); setIsIncomeModalOpen(true); }} className="flex-1 md:flex-none bg-stone-800 hover:bg-stone-700 text-emerald-400 px-5 py-3 rounded-xl font-bold text-sm flex items-center justify-center gap-2 border border-stone-700"><ArrowUpCircle size={18} /> Ingreso</button>
                                <button onClick={() => { setEditingFinanceId(null); setExpenseForm({description: '', amount: '', method: 'cash', mixedCash: '', mixedTransfer: '', date: new Date().toISOString()}); setIsExpenseModalOpen(true); }} className="flex-1 md:flex-none bg-stone-800 hover:bg-stone-700 text-red-400 px-5 py-3 rounded-xl font-bold text-sm flex items-center justify-center gap-2 border border-stone-700"><ArrowDownCircle size={18} /> Gasto</button>
                            </div>
                        </div>
                    </div>

                {/* BOTONES DE FILTRO CON EL NUEVO BOTÓN DE GASTOS */}
                    <div className="flex gap-2 overflow-x-auto pb-1 no-scrollbar items-center justify-end md:justify-start">
                        <span className="text-xs font-bold text-stone-400 mr-2 uppercase tracking-wide hidden md:inline">Filtrar vista:</span>
                        
                        <button onClick={() => setFinanceFilter('all')} className={`px-4 py-2 rounded-xl text-xs font-bold whitespace-nowrap transition-all border ${financeFilter === 'all' ? 'bg-stone-900 text-white border-stone-900 shadow-md' : 'bg-white text-stone-500 border-stone-200 hover:bg-stone-50'}`}>
                            Todos
                        </button>
                        
                        {/* --- BOTÓN NUEVO ROJO (SOLO GASTOS) --- */}
                        <button onClick={() => setFinanceFilter('expenses')} className={`px-4 py-2 rounded-xl text-xs font-bold whitespace-nowrap transition-all border flex items-center gap-2 ${financeFilter === 'expenses' ? 'bg-red-600 text-white border-red-600 shadow-md' : 'bg-white text-stone-500 border-stone-200 hover:bg-stone-50'}`}>
                            <ArrowDownCircle size={14}/> Solo Gastos
                        </button>
                        {/* -------------------------------------- */}

                        <button onClick={() => setFinanceFilter('cash')} className={`px-4 py-2 rounded-xl text-xs font-bold whitespace-nowrap transition-all border flex items-center gap-2 ${financeFilter === 'cash' ? 'bg-emerald-600 text-white border-emerald-600 shadow-md' : 'bg-white text-stone-500 border-stone-200 hover:bg-stone-50'}`}>
                            <Banknote size={14}/> Solo Efectivo
                        </button>
                        
                        <button onClick={() => setFinanceFilter('transfer')} className={`px-4 py-2 rounded-xl text-xs font-bold whitespace-nowrap transition-all border flex items-center gap-2 ${financeFilter === 'transfer' ? 'bg-blue-600 text-white border-blue-600 shadow-md' : 'bg-white text-stone-500 border-stone-200 hover:bg-stone-50'}`}>
                            <CreditCard size={14}/> Solo Digital
                        </button>
                        
                        <button onClick={() => setFinanceFilter('mixed')} className={`px-4 py-2 rounded-xl text-xs font-bold whitespace-nowrap transition-all border flex items-center gap-2 ${financeFilter === 'mixed' ? 'bg-amber-600 text-white border-amber-600 shadow-md' : 'bg-white text-stone-500 border-stone-200 hover:bg-stone-50'}`}>
                            <Grid size={14}/> Solo Mixto
                        </button>
                    </div>
                    {/* TARJETAS DE RESUMEN (DINÁMICAS) */}
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div className="glass-panel p-6 rounded-2xl shadow-sm border border-stone-200/50 bg-white">
                            <div className="flex items-center gap-2 mb-2">
                                <ArrowDownLeft size={16} className="text-emerald-600"/>
                                <span className="text-xs font-bold uppercase text-stone-400">
                                    Ingresos {financeFilter === 'all' ? '' : 'Filtrado'}
                                </span>
                            </div>
                            <p className="text-2xl font-bold text-emerald-600 animate-in fade-in duration-300">+${currentViewIncome.toLocaleString()}</p>
                        </div>
                        <div className="glass-panel p-6 rounded-2xl shadow-sm border border-stone-200/50 bg-white">
                            <div className="flex items-center gap-2 mb-2">
                                <ArrowUpRight size={16} className="text-red-500"/>
                                <span className="text-xs font-bold uppercase text-stone-400">
                                    Gastos {financeFilter === 'all' ? '' : 'Filtrado'}
                                </span>
                            </div>
                            <p className="text-2xl font-bold text-red-500 animate-in fade-in duration-300">-${currentViewExpense.toLocaleString()}</p>
                        </div>
                        <div className={`glass-panel p-6 rounded-2xl shadow-sm border border-stone-200/50 ${currentViewNet >= 0 ? 'bg-emerald-50/50' : 'bg-red-50/50'}`}>
                            <div className="flex items-center gap-2 mb-2">
                                <Activity size={16} className="text-stone-600"/>
                                <span className="text-xs font-bold uppercase text-stone-500">Neto {financeFilter === 'all' ? '' : 'Filtrado'}</span>
                            </div>
                            <p className={`text-2xl font-bold animate-in fade-in duration-300 ${currentViewNet >= 0 ? 'text-emerald-700' : 'text-red-700'}`}>${currentViewNet.toLocaleString()}</p>
                        </div>
                    </div>

                    {/* TABLA DE MOVIMIENTOS */}
                    <div className="bg-white rounded-2xl border border-stone-100 shadow-sm overflow-hidden">
                        <div className="px-6 py-4 border-b border-stone-50 bg-stone-50/30 flex justify-between items-center">
                            <h3 className="font-bold text-stone-800">Movimientos Recientes</h3>
                            <span className="text-xs text-stone-400 font-medium bg-white px-2 py-1 rounded border border-stone-100">{filteredMovements.length} regs.</span>
                        </div>
                        
                        {/* Vista Escritorio: Tabla */}
                        <div className="hidden md:block overflow-x-auto">
                            <table className="w-full text-sm">
                                <thead className="bg-stone-50 text-xs text-stone-500 uppercase font-bold text-left"><tr><th className="px-6 py-3">Fecha</th><th className="px-6 py-3">Detalle</th><th className="px-6 py-3 text-right">Monto</th><th className="px-6 py-3 text-right">Acciones</th></tr></thead>
                                <tbody className="divide-y divide-stone-50">
                                    {filteredMovements.map((m, i) => (
                                        <tr key={i} className="hover:bg-stone-50/50 transition-colors group">
                                            <td className="px-6 py-3.5 text-stone-500 whitespace-nowrap">{new Date(m.date).toLocaleDateString()}</td>
                                            <td className="px-6 py-3.5 font-medium text-stone-800">
                                                {m.desc} 
                                                <span className={`text-[10px] px-1.5 rounded ml-2 ${m.type === 'income' ? 'bg-emerald-100 text-emerald-700' : 'bg-red-100 text-red-700'}`}>{m.type === 'income' ? 'IN' : 'OUT'}</span>
                                                {m.paymentMethod === 'mixed' && <span className="ml-1 text-[9px] bg-amber-100 text-amber-700 px-1 rounded border border-amber-200">Mixto</span>}
                                            </td>
                                            <td className={`px-6 py-3.5 text-right font-bold ${m.type === 'income' ? 'text-emerald-600' : 'text-red-500'}`}>{m.type==='income' ? '+' : '-'}${m.amount.toLocaleString()}</td>
                                            <td className="px-6 py-3.5 text-right">
    <div className="flex justify-end gap-1 opacity-50 group-hover:opacity-100 transition-opacity">
        <button onClick={() => handleEditFinance(m)} className="p-1.5 hover:bg-stone-100 rounded text-stone-500"><Pencil size={14}/></button>
        <button onClick={() => handleDeleteFinance(m)} className="p-1.5 hover:bg-red-50 rounded text-red-500"><Trash2 size={14}/></button>
    </div>
</td>
                                        </tr>
                                    ))}
                                    {filteredMovements.length === 0 && <tr><td colSpan="4" className="px-6 py-8 text-center text-stone-400">No hay movimientos con este filtro</td></tr>}
                                </tbody>
                            </table>
                        </div>

                        {/* Vista Móvil: Cards */}
                        {/* Vista Móvil: Cards */}
                        <div className="md:hidden p-4 space-y-3">
                            {filteredMovements.map((m, i) => (
                                <div key={i} className="bg-stone-50 p-4 rounded-xl border border-stone-100 flex justify-between items-center group">
                                    <div>
                                        <p className="text-xs text-stone-400 font-mono mb-1">{new Date(m.date).toLocaleDateString()}</p>
                                        <p className="font-bold text-stone-900 leading-tight">{m.desc}</p>
                                        <div className="flex gap-1 mt-1">
                                            <span className={`text-[10px] px-1.5 rounded inline-block font-bold ${m.type === 'income' ? 'bg-emerald-100 text-emerald-700' : 'bg-red-100 text-red-700'}`}>{m.type === 'income' ? 'INGRESO' : 'GASTO'}</span>
                                            {m.paymentMethod === 'mixed' && <span className="text-[10px] px-1.5 rounded inline-block font-bold bg-amber-100 text-amber-700 border border-amber-200">Mixto</span>}
                                        </div>
                                    </div>
                                    <div className="text-right">
                                        <p className={`text-lg font-bold ${m.type === 'income' ? 'text-emerald-600' : 'text-red-500'}`}>{m.type==='income' ? '+' : '-'}${m.amount.toLocaleString()}</p>
                                        
                                        {/* BOTONES VISIBLES SIEMPRE (SIN IF) */}
                                        <div className="flex justify-end gap-2 mt-2">
                                            <button onClick={() => handleEditFinance(m)} className="text-stone-400 hover:text-stone-600"><Pencil size={16}/></button>
                                            <button onClick={() => handleDeleteFinance(m)} className="text-stone-400 hover:text-red-500"><Trash2 size={16}/></button>
                                        </div>
                                    </div>
                                </div>
                            ))}
                            {filteredMovements.length === 0 && <p className="text-center text-stone-400 py-6">No hay movimientos con este filtro</p>}
                        </div>
                    </div>
                </>
            );
        })()}
    </div>
)}

                            {activeTab === 'debts' && (
                                <div className="space-y-6 animate-in fade-in slide-in-from-right-4 duration-300">
                                    <div className="flex justify-between items-center">
                                        <div><h3 className="font-bold text-xl brand-font">Deudas & Cuotas</h3><p className="text-sm text-stone-500">Gestión de pasivos</p></div>
                                        <div className="flex gap-2">
                                            <button onClick={() => setIsDebtStatsModalOpen(true)} className="bg-white border border-stone-200 text-stone-600 px-4 py-2 rounded-xl text-sm font-bold flex items-center gap-2 hover:bg-stone-50 hover:text-stone-800"><CalendarClock size={16}/> <span className="hidden md:inline">Estadísticas</span></button>
                                            <button onClick={() => setIsDebtModalOpen(true)} className="bg-stone-900 text-white px-4 py-2 rounded-xl text-sm font-bold flex items-center gap-2 hover:bg-stone-800 shadow-lg shadow-stone-900/10"><Plus size={16}/> <span className="hidden md:inline">Nueva</span></button>
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        {debts.map(d => (
                                            <div key={d.id} className="bg-white p-5 rounded-2xl border border-stone-100 shadow-sm flex items-center justify-between group">
                                                <div>
                                                    <h4 className={`font-bold text-lg ${d.paid ? 'line-through text-stone-300' : 'text-stone-800'}`}>{d.detail}</h4>
                                                    <p className="text-xs text-stone-400 mt-1">{new Date(d.date).toLocaleDateString()} • {d.paid ? 'Pagado' : 'Pendiente'}</p>
                                                </div>
                                                <div className="flex items-center gap-4">
                                                    <span className={`text-xl font-bold brand-font ${d.paid ? 'text-stone-300' : 'text-red-500'}`}>${d.amount.toLocaleString()}</span>
                                                    <div className="flex gap-2">
                                                        <button onClick={() => handleSimpleSave('debts', { paid: !d.paid }, () => {}, () => {}, {}, d.id)} className={`p-2 rounded-full transition-colors ${d.paid ? 'bg-emerald-100 text-emerald-600' : 'bg-stone-100 text-stone-400 hover:bg-stone-200'}`}>{d.paid ? <Check size={18}/> : <Circle size={18}/>}</button>
                                                        <button onClick={() => handleDelete('debts', d.id)} className="p-2 text-stone-300 hover:text-red-500 md:opacity-0 md:group-hover:opacity-100 transition-all"><Trash2 size={18}/></button>
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                    {debts.length === 0 && <div className="text-center py-12 text-stone-400 bg-white rounded-2xl border border-dashed border-stone-200">No hay deudas registradas</div>}
                                </div>
                            )}

                            {activeTab === 'stats' && (
                                <div className="space-y-6 animate-in fade-in slide-in-from-right-4 duration-300">
                                    <div className="bg-white rounded-3xl p-6 md:p-8 border border-stone-200 shadow-sm relative overflow-hidden">
                                        <div className="relative z-10">
                                            <h2 className="text-2xl font-bold brand-font mb-1">Rendimiento Anual</h2>
                                            <p className="text-stone-500 text-sm mb-6">Análisis inteligente de ventas {currentDate.getFullYear()}</p>
                                            <div className="h-40 mb-8"><SimpleChart data={stats.chartData} /></div>
                                            <div className="grid grid-cols-2 gap-8 pt-6 border-t border-stone-100">
                                                <div><p className="text-xs text-stone-400 font-bold uppercase tracking-widest mb-1">Total Facturado</p><h3 className="text-3xl font-bold text-stone-900 brand-font">${stats.totalRevenue.toLocaleString()}</h3></div>
                                                <div><p className="text-xs text-stone-400 font-bold uppercase tracking-widest mb-1">Total Ventas</p><h3 className="text-3xl font-bold text-stone-900 brand-font">{stats.count}</h3></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div className="bg-white rounded-3xl p-6 md:p-8 border border-stone-200 shadow-sm">
                                        <h3 className="font-bold text-stone-800 mb-4 flex items-center gap-2"><Crown size={18} className="text-amber-500"/> Categorías Top</h3>
                                        <div className="space-y-4">
                                            {stats.topCats.map((cat, i) => (
                                                <div key={i} className="flex items-center gap-4">
                                                    <span className="w-6 text-stone-300 font-bold font-mono text-sm">0{i+1}</span>
                                                    <div className="flex-1">
                                                        <div className="flex justify-between text-sm mb-1"><span className="font-medium text-stone-700">{cat.name}</span><span className="text-stone-400">{cat.value} ventas</span></div>
                                                        <div className="h-2 bg-stone-100 rounded-full overflow-hidden"><div className="h-full bg-stone-800 rounded-full" style={{ width: `${(cat.value / (stats.topCats[0].value || 1)) * 100}%` }}></div></div>
                                                    </div>
                                                </div>
                                            ))}
                                            {stats.topCats.length === 0 && <p className="text-stone-400 text-sm">Sin datos suficientes.</p>}
                                        </div>
                                    </div>
                                </div>
                            )}

                        </div>
                        
                        {/* Mobile Nav */}
                        <div className="md:hidden bg-white border-t border-stone-200 flex justify-between px-4 pb-safe pt-2 z-40 fixed bottom-0 w-full shadow-[0_-5px_15px_rgba(0,0,0,0.05)]">
                            {[
                                {id: 'orders', icon: Home, label: 'Pedidos'},
                                {id: 'clients', icon: Users, label: 'Clientes'},
                                {id: 'debts', icon: Receipt, label: 'Deudas'},
                                {id: 'finances', icon: Wallet, label: 'Finanzas'},
                            ].map(t => (
                                <button key={t.id} onClick={() => { setActiveTab(t.id); setIsMobileMenuOpen(false); }} className={`mobile-nav-item ${activeTab === t.id && !isMobileMenuOpen ? 'active' : ''}`}>
                                    <t.icon size={22} />
                                    <span className="text-[10px] font-bold mt-1">{t.label}</span>
                                </button>
                            ))}
                            <button onClick={() => setIsMobileMenuOpen(!isMobileMenuOpen)} className={`mobile-nav-item ${isMobileMenuOpen ? 'text-stone-900' : ''}`}>
                                <Menu size={22} />
                                <span className="text-[10px] font-bold mt-1">Menú</span>
                            </button>
                        </div>
                        
                        {/* Mobile Menu Overlay */}
                        {isMobileMenuOpen && (
                            <div className="md:hidden fixed inset-0 z-30 bg-black/80 backdrop-blur-sm animate-in fade-in duration-200 flex flex-col justify-end pb-24" onClick={() => setIsMobileMenuOpen(false)}>
                                <div className="bg-white rounded-t-3xl p-6 animate-in slide-in-from-bottom-10 duration-300" onClick={e => e.stopPropagation()}>
                                    <div className="flex items-center justify-center mb-6">
                                        <div className="w-12 h-1 bg-stone-200 rounded-full"></div>
                                    </div>
                                    <h3 className="font-bold text-xl text-stone-900 brand-font mb-6 px-2">Más Opciones</h3>
                                    <div className="grid grid-cols-2 gap-4">
                                        <button onClick={() => { setActiveTab('suppliers'); setIsMobileMenuOpen(false); }} className="p-4 bg-stone-50 hover:bg-stone-100 rounded-xl flex flex-col items-center gap-2 transition-colors">
                                            <div className="w-10 h-10 rounded-full bg-white shadow-sm flex items-center justify-center text-stone-700"><Truck size={20}/></div>
                                            <span className="font-bold text-stone-700 text-sm">Proveedores</span>
                                        </button>
                                        <button onClick={() => { setActiveTab('stats'); setIsMobileMenuOpen(false); }} className="p-4 bg-stone-50 hover:bg-stone-100 rounded-xl flex flex-col items-center gap-2 transition-colors">
                                            <div className="w-10 h-10 rounded-full bg-white shadow-sm flex items-center justify-center text-amber-600"><BarChart3 size={20}/></div>
                                            <span className="font-bold text-stone-700 text-sm">Estadísticas</span>
                                        </button>
                                        <button onClick={() => { setTempCredentials({...credentials}); setIsSettingsOpen(true); setIsMobileMenuOpen(false); }} className="p-4 bg-stone-50 hover:bg-stone-100 rounded-xl flex flex-col items-center gap-2 transition-colors">
                                            <div className="w-10 h-10 rounded-full bg-white shadow-sm flex items-center justify-center text-stone-500"><Settings size={20}/></div>
                                            <span className="font-bold text-stone-700 text-sm">Configuración</span>
                                        </button>
                                        <button onClick={handleLogout} className="p-4 bg-red-50 hover:bg-red-100 rounded-xl flex flex-col items-center gap-2 transition-colors">
                                            <div className="w-10 h-10 rounded-full bg-white shadow-sm flex items-center justify-center text-red-500"><LogOut size={20}/></div>
                                            <span className="font-bold text-red-600 text-sm">Cerrar Sesión</span>
                                        </button>
                                    </div>
                                    <div className="mt-8 text-center">
                                         <p className="text-[10px] text-stone-400">Osiris Mobile v1.1 • Powered by JA</p>
                                    </div>
                                </div>
                            </div>
                        )}
                    </main>

                    {/* --- MODALS --- */}
                    <Modal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} title={editingId ? "Editar Pedido" : "Nuevo Pedido"} maxWidth="max-w-2xl">
                        <form onSubmit={handleSaveOrder} className="space-y-5">
                            <div className="flex flex-col md:flex-row gap-4">
                                <div className="space-y-1 flex-1">
                                    <label className="text-xs font-bold text-stone-500 uppercase tracking-widest">Fecha</label>
                                    <input type="date" className="w-full p-3 bg-stone-50 border border-stone-200 rounded-xl focus:border-stone-400 outline-none" value={form.date} onChange={e => setForm({...form, date: e.target.value})} />
                                </div>
                                <div className="space-y-1 flex-[2]">
                                    <label className="text-xs font-bold text-stone-500 uppercase tracking-widest">Cliente</label>
                                    <ClientSelector clients={clients} value={form.client} onChange={(val) => setForm({...form, client: val})} />
                                </div>
                            </div>

                            {/* SECCIÓN CARRITO DE COMPRAS */}
                            <div className="bg-stone-50 p-4 rounded-xl border border-stone-200 space-y-4">
                                <h4 className="text-sm font-bold text-stone-800 flex items-center gap-2"><ShoppingCart size={16}/> Agregar Productos</h4>
                                
                                <div className="flex flex-col md:flex-row gap-3 items-end">
                                    <div className="space-y-1 flex-[2] w-full">
                                        <label className="text-[10px] font-bold text-stone-400 uppercase">Detalle</label>
                                        <input type="text" placeholder="Ej: Remera negra..." className="w-full p-2.5 bg-white border border-stone-200 rounded-lg text-sm" value={lineItem.detail} onChange={e => setLineItem({...lineItem, detail: e.target.value})} />
                                    </div>
                                    <div className="flex gap-2 w-full md:w-auto">
                                        <div className="space-y-1 w-20">
                                            <label className="text-[10px] font-bold text-stone-400 uppercase">Cant.</label>
                                            <input type="number" min="1" className="w-full p-2.5 bg-white border border-stone-200 rounded-lg text-sm text-center" value={lineItem.quantity} onChange={e => setLineItem({...lineItem, quantity: e.target.value})} />
                                        </div>
                                        <div className="space-y-1 w-28">
                                            <label className="text-[10px] font-bold text-stone-400 uppercase">Precio Unit.</label>
                                            <input type="number" placeholder="$" className="w-full p-2.5 bg-white border border-stone-200 rounded-lg text-sm" value={lineItem.unitPrice} onChange={e => setLineItem({...lineItem, unitPrice: e.target.value})} />
                                        </div>
                                    </div>
                                    <button type="button" onClick={handleAddItem} className="bg-stone-800 text-white p-2.5 rounded-lg hover:bg-stone-700 transition-colors w-full md:w-auto flex items-center justify-center"><Plus size={20}/></button>
                                </div>

                                {/* LISTA DE ITEMS */}
                                <div className="bg-white rounded-lg border border-stone-200 overflow-hidden">
                                    <table className="w-full text-sm">
                                        <thead className="bg-stone-100 text-[10px] uppercase text-stone-500 font-bold text-left">
                                            <tr>
                                                <th className="px-3 py-2">Prod</th>
                                                <th className="px-3 py-2 text-center">Cant</th>
                                                <th className="px-3 py-2 text-right">Unit</th>
                                                <th className="px-3 py-2 text-right">Subtotal</th>
                                                <th className="px-3 py-2"></th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-stone-100">
                                            {form.items.map((item, idx) => (
                                                <tr key={idx}>
                                                    <td className="px-3 py-2 font-medium text-stone-700">{item.detail}</td>
                                                    <td className="px-3 py-2 text-center text-stone-500">{item.quantity}</td>
                                                    <td className="px-3 py-2 text-right text-stone-500">${item.unitPrice.toLocaleString()}</td>
                                                    <td className="px-3 py-2 text-right font-bold text-stone-800">${item.totalPrice.toLocaleString()}</td>
                                                    <td className="px-3 py-2 text-right">
                                                        <button type="button" onClick={() => handleRemoveItem(idx)} className="text-red-400 hover:text-red-600"><X size={14}/></button>
                                                    </td>
                                                </tr>
                                            ))}
                                            {form.items.length === 0 && <tr><td colSpan="5" className="px-3 py-4 text-center text-xs text-stone-400 italic">Carrito vacío</td></tr>}
                                        </tbody>
                                        <tfoot className="bg-stone-50 font-bold border-t border-stone-200">
                                            <tr>
                                                <td colSpan="3" className="px-3 py-3 text-right text-stone-600 uppercase text-xs">Total Final</td>
                                                <td className="px-3 py-3 text-right text-lg text-stone-900">${form.price.toLocaleString()}</td>
                                                <td></td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                            
                            <div className="pt-2"><button type="button" onClick={() => setForm({...form, important: !form.important})} className={`w-full py-3 rounded-xl border flex items-center justify-center gap-2 transition-colors ${form.important ? 'bg-amber-50 border-amber-200 text-amber-600' : 'bg-white border-stone-200 text-stone-400'}`}><Star size={18} fill={form.important ? "currentColor" : "none"} /> Marcar como Importante</button></div>
                            <button type="submit" disabled={isSaving} className="w-full bg-stone-900 hover:bg-stone-800 text-white py-4 rounded-xl font-bold flex items-center justify-center gap-2 mt-4">{isSaving ? <Loader2 className="animate-spin"/> : (editingId ? 'Guardar Cambios' : 'Registrar Pedido')}</button>
                        </form>
                    </Modal>

                    {/* Client Modal */}
                    <Modal isOpen={isClientModalOpen} onClose={() => setIsClientModalOpen(false)} title={editingClientId ? "Editar Cliente" : "Nuevo Cliente"}>
                        <form onSubmit={(e) => { e.preventDefault(); handleSimpleSave('clients', clientForm, setIsClientModalOpen, setClientForm, {name:'', phone:'', email:'', address:'', notes:''}, editingClientId) }} className="space-y-5">
                             <div className="space-y-1"><label className="text-xs font-bold text-stone-500 uppercase tracking-widest">Nombre</label><input type="text" autoFocus className="w-full p-3 bg-stone-50 border rounded-xl" value={clientForm.name} onChange={e => setClientForm({...clientForm, name: e.target.value})} /></div>
                             <div className="space-y-1"><label className="text-xs font-bold text-stone-500 uppercase tracking-widest">Teléfono</label><input type="text" className="w-full p-3 bg-stone-50 border rounded-xl" value={clientForm.phone} onChange={e => setClientForm({...clientForm, phone: e.target.value})} /></div>
                             <div className="space-y-1"><label className="text-xs font-bold text-stone-500 uppercase tracking-widest">Dirección</label><input type="text" className="w-full p-3 bg-stone-50 border rounded-xl" value={clientForm.address} onChange={e => setClientForm({...clientForm, address: e.target.value})} /></div>
                             <div className="space-y-1"><label className="text-xs font-bold text-stone-500 uppercase tracking-widest">Email (Opcional)</label><input type="email" className="w-full p-3 bg-stone-50 border rounded-xl" value={clientForm.email} onChange={e => setClientForm({...clientForm, email: e.target.value})} /></div>
                             <button type="submit" disabled={isSaving} className="w-full bg-stone-900 text-white py-3.5 rounded-xl font-bold">Guardar Cliente</button>
                        </form>
                    </Modal>

                    {/* CLIENT STATISTICS MODAL */}
                    <Modal isOpen={isClientStatsModalOpen} onClose={() => setIsClientStatsModalOpen(false)} title="Estadísticas de Clientes" maxWidth="max-w-2xl">
                         <div className="space-y-6">
                             {/* KPIS */}
                             <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div className="bg-stone-50 p-4 rounded-xl text-center">
                                    <p className="text-[10px] text-stone-400 uppercase font-bold tracking-widest">Total Clientes</p>
                                    <p className="text-2xl font-bold text-stone-900 mt-1">{clients.length}</p>
                                </div>
                                <div className="bg-stone-50 p-4 rounded-xl text-center">
                                    <p className="text-[10px] text-stone-400 uppercase font-bold tracking-widest">Deuda Total</p>
                                    <p className="text-2xl font-bold text-red-500 mt-1">${globalClientStats.totalDebt.toLocaleString()}</p>
                                </div>
                                <div className="bg-stone-50 p-4 rounded-xl text-center">
                                    <p className="text-[10px] text-stone-400 uppercase font-bold tracking-widest">Ticket Promedio</p>
                                    <p className="text-2xl font-bold text-emerald-600 mt-1">${Math.round(globalClientStats.avgTicket).toLocaleString()}</p>
                                </div>
                                <div className="bg-stone-50 p-4 rounded-xl text-center">
                                    <p className="text-[10px] text-stone-400 uppercase font-bold tracking-widest">Top Ventas</p>
                                    <p className="text-2xl font-bold text-amber-500 mt-1">{globalClientStats.topSpenders[0]?.name.split(' ')[0] || '-'}</p>
                                </div>
                             </div>

                             <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                {/* TOP SPENDERS */}
                                <div className="border border-stone-100 rounded-xl p-4 bg-white shadow-sm">
                                    <h4 className="font-bold text-stone-900 mb-4 flex items-center gap-2"><Award size={18} className="text-amber-500"/> Top 5 Clientes (Gastos)</h4>
                                    <div className="space-y-3">
                                        {globalClientStats.topSpenders.length === 0 ? <p className="text-center text-stone-400 text-sm py-4">Sin datos</p> : 
                                        globalClientStats.topSpenders.map((c, i) => (
                                            <div key={c.id} className="flex justify-between items-center text-sm">
                                                <div className="flex items-center gap-3">
                                                    <span className={`w-5 h-5 flex items-center justify-center rounded-full text-[10px] font-bold ${i===0 ? 'bg-amber-100 text-amber-700' : 'bg-stone-100 text-stone-500'}`}>{i+1}</span>
                                                    <span className="font-medium text-stone-700">{c.name}</span>
                                                </div>
                                                <span className="font-bold text-stone-900">${c.stats.spent.toLocaleString()}</span>
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                {/* TOP DEBTORS */}
                                <div className="border border-stone-100 rounded-xl p-4 bg-white shadow-sm">
                                    <h4 className="font-bold text-stone-900 mb-4 flex items-center gap-2"><AlertTriangle size={18} className="text-red-500"/> Top Deudores</h4>
                                    <div className="space-y-3">
                                        {globalClientStats.topDebtors.length === 0 ? <p className="text-center text-stone-400 text-sm py-4">Sin deudas registradas</p> : 
                                        globalClientStats.topDebtors.map((c, i) => (
                                            <div key={c.id} className="flex justify-between items-center text-sm">
                                                <div className="flex items-center gap-3">
                                                    <span className="w-5 h-5 flex items-center justify-center rounded-full bg-red-50 text-red-500 text-[10px] font-bold">{i+1}</span>
                                                    <span className="font-medium text-stone-700">{c.name}</span>
                                                </div>
                                                <span className="font-bold text-red-500">${c.stats.debt.toLocaleString()}</span>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                             </div>
                         </div>
                    </Modal>
                    
                    {/* DEBT STATS MODAL (NUEVO) */}
                    <Modal isOpen={isDebtStatsModalOpen} onClose={() => setIsDebtStatsModalOpen(false)} title="Previsión de Pagos" maxWidth="max-w-lg">
                        <div className="space-y-4">
                            <p className="text-sm text-stone-500 mb-4">Total a pagar mes a mes (basado en deudas pendientes).</p>
                            <div className="space-y-2">
                                {debtStats.map((d, i) => {
                                    const [y, m] = d.date.split('-');
                                    const dateObj = new Date(parseInt(y), parseInt(m)-1, 10);
                                    const label = new Intl.DateTimeFormat('es-AR', { month: 'long', year: 'numeric' }).format(dateObj);
                                    const isPast = new Date() > new Date(parseInt(y), parseInt(m), 0); // Check if month is fully past

                                    return (
                                        <div key={d.date} className={`flex justify-between items-center p-4 rounded-xl border ${isPast ? 'bg-red-50 border-red-100' : 'bg-white border-stone-100 shadow-sm'}`}>
                                            <div className="flex items-center gap-3">
                                                <div className={`p-2 rounded-lg ${isPast ? 'bg-red-100 text-red-600' : 'bg-stone-100 text-stone-500'}`}>
                                                    <CalendarClock size={18}/>
                                                </div>
                                                <div>
                                                    <p className={`font-bold capitalize ${isPast ? 'text-red-700' : 'text-stone-800'}`}>{label}</p>
                                                    {isPast && <span className="text-[10px] text-red-500 font-bold uppercase">Vencido</span>}
                                                </div>
                                            </div>
                                            <span className={`text-lg font-bold ${isPast ? 'text-red-600' : 'text-stone-800'}`}>${d.amount.toLocaleString()}</span>
                                        </div>
                                    );
                                })}
                                {debtStats.length === 0 && <p className="text-center text-stone-400 py-8">¡Excelente! No tienes deudas pendientes.</p>}
                            </div>
                        </div>
                    </Modal>

                    {/* Supplier Modal */}
                    <Modal isOpen={isSupplierModalOpen} onClose={() => setIsSupplierModalOpen(false)} title={editingSupplierId ? "Editar Proveedor" : "Nuevo Proveedor"}>
                        <form onSubmit={(e) => { e.preventDefault(); handleSimpleSave('suppliers', supplierForm, setIsSupplierModalOpen, setSupplierForm, {name:'', cuit:'', phone:'', address:'', products:'', notes:''}, editingSupplierId) }} className="space-y-5">
                             <div className="space-y-1"><label className="text-xs font-bold text-stone-500 uppercase tracking-widest">Razón Social / Nombre</label><input type="text" autoFocus className="w-full p-3 bg-stone-50 border rounded-xl" value={supplierForm.name} onChange={e => setSupplierForm({...supplierForm, name: e.target.value})} /></div>
                             <div className="space-y-1"><label className="text-xs font-bold text-stone-500 uppercase tracking-widest">Productos / Rubro</label><input type="text" className="w-full p-3 bg-stone-50 border rounded-xl" value={supplierForm.products} onChange={e => setSupplierForm({...supplierForm, products: e.target.value})} /></div>
                             <div className="grid grid-cols-2 gap-4">
                                <div className="space-y-1"><label className="text-xs font-bold text-stone-500 uppercase tracking-widest">CUIT</label><input type="text" className="w-full p-3 bg-stone-50 border rounded-xl" value={supplierForm.cuit} onChange={e => setSupplierForm({...supplierForm, cuit: e.target.value})} /></div>
                                <div className="space-y-1"><label className="text-xs font-bold text-stone-500 uppercase tracking-widest">Teléfono</label><input type="text" className="w-full p-3 bg-stone-50 border rounded-xl" value={supplierForm.phone} onChange={e => setSupplierForm({...supplierForm, phone: e.target.value})} /></div>
                             </div>
                             <div className="space-y-1"><label className="text-xs font-bold text-stone-500 uppercase tracking-widest">Dirección</label><input type="text" className="w-full p-3 bg-stone-50 border rounded-xl" value={supplierForm.address} onChange={e => setSupplierForm({...supplierForm, address: e.target.value})} /></div>
                             <button type="submit" disabled={isSaving} className="w-full bg-stone-900 text-white py-3.5 rounded-xl font-bold">Guardar Proveedor</button>
                        </form>
                    </Modal>

                    {/* Supplier Order Modal */}
                    <Modal isOpen={isSupplierOrderModalOpen} onClose={() => setIsSupplierOrderModalOpen(false)} title="Orden de Compra (Stock)">
                        <form onSubmit={(e) => { e.preventDefault(); handleSimpleSave('supplier_orders', supplierOrderForm, setIsSupplierOrderModalOpen, setSupplierOrderForm, {supplierId:'', detail:'', amount:'', date: new Date().toISOString().split('T')[0], received: false}) }} className="space-y-5">
                             <div className="space-y-1"><label className="text-xs font-bold text-stone-500 uppercase tracking-widest">Proveedor</label>
                                <select className="w-full p-3 bg-stone-50 border rounded-xl" value={supplierOrderForm.supplierId} onChange={e => setSupplierOrderForm({...supplierOrderForm, supplierId: e.target.value})}>
                                    <option value="">Seleccionar...</option>
                                    {suppliers.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                                </select>
                             </div>
                             <div className="space-y-1"><label className="text-xs font-bold text-stone-500 uppercase tracking-widest">Fecha</label><input type="date" className="w-full p-3 bg-stone-50 border rounded-xl" value={supplierOrderForm.date} onChange={e => setSupplierOrderForm({...supplierOrderForm, date: e.target.value})} /></div>
                             <div className="space-y-1"><label className="text-xs font-bold text-stone-500 uppercase tracking-widest">Detalle Mercadería</label><input type="text" placeholder="Ej: 20 Jeans, 10 Remeras..." className="w-full p-3 bg-stone-50 border rounded-xl" value={supplierOrderForm.detail} onChange={e => setSupplierOrderForm({...supplierOrderForm, detail: e.target.value})} /></div>
                             <div className="space-y-1"><label className="text-xs font-bold text-stone-500 uppercase tracking-widest">Costo Total</label><input type="number" className="w-full p-3 bg-stone-50 border rounded-xl font-mono text-lg" value={supplierOrderForm.amount} onChange={e => setSupplierOrderForm({...supplierOrderForm, amount: e.target.value})} /></div>
                             <button type="submit" disabled={isSaving} className="w-full bg-stone-900 text-white py-3.5 rounded-xl font-bold">Registrar Compra</button>
                        </form>
                    </Modal>

<Modal isOpen={isPaymentModalOpen} onClose={() => setIsPaymentModalOpen(false)} title="Registrar Cobro">
                        {paymentModalStep === 'select' ? (
                            <div className="space-y-3">
                                {(() => {
                                    const order = orders.find(o => o.id === pendingPaymentId);
                                    const remaining = order ? (order.price - (order.amountPaid || 0)) : 0;
                                    return (
                                        <>
                                            <div className="text-center mb-4">
                                                <p className="text-stone-400 text-xs uppercase font-bold">Resta por cobrar</p>
                                                <p className="text-3xl font-bold text-stone-800">${remaining.toLocaleString()}</p>
                                            </div>
                                            <div className="grid grid-cols-2 gap-3">
                                                <button onClick={() => handleConfirmPayment('cash')} className="flex flex-col items-center p-4 bg-emerald-50 border border-emerald-100 rounded-2xl hover:bg-emerald-100 transition-all group">
                                                    <Banknote size={24} className="text-emerald-600 mb-2"/>
                                                    <span className="font-bold text-emerald-800 text-sm">Efectivo Total</span>
                                                </button>
                                                <button onClick={() => handleConfirmPayment('transfer')} className="flex flex-col items-center p-4 bg-blue-50 border border-blue-100 rounded-2xl hover:bg-blue-100 transition-all group">
                                                    <CreditCard size={24} className="text-blue-600 mb-2"/>
                                                    <span className="font-bold text-blue-800 text-sm">Digital Total</span>
                                                </button>
                                            </div>
                                            <div className="grid grid-cols-2 gap-3 pt-2">
                                                 <button onClick={() => setPaymentModalStep('mixed')} className="py-3 px-4 bg-stone-100 rounded-xl text-stone-600 font-bold text-xs hover:bg-stone-200">Pago Mixto</button>
                                               <button onClick={() => { setPaymentModalStep('partial'); setPartialMethod('cash'); }} className="py-3 px-4 bg-amber-100 text-amber-700 border border-amber-200 rounded-xl font-bold text-xs hover:bg-amber-200 flex items-center justify-center gap-2"><PieChart size={14}/> Pago Parcial</button>
                                            </div>
                                        </>
                                    );
                                })()}
                            </div>
                        ) : paymentModalStep === 'partial' ? (
                            <div className="space-y-4 animate-in slide-in-from-right-4">
                                {(() => {
                                    const order = orders.find(o => o.id === pendingPaymentId);
                                    const remaining = order ? (order.price - (order.amountPaid || 0)) : 0;
                                    return (
    <>
        {/* 1. Cuadro de Deuda (YA LO TIENES) */}
        <div className="bg-amber-50 border border-amber-100 p-4 rounded-xl">
            <p className="text-amber-800 text-xs font-bold uppercase mb-1">Deuda Actual</p>
            <p className="text-2xl font-bold text-amber-600">${remaining.toLocaleString()}</p>
        </div>

        {/* 2. BOTONES DE SELECCIÓN (ESTO ES LO NUEVO QUE AGREGAMOS) */}
        <div className="grid grid-cols-2 gap-2">
            <button 
                onClick={() => setPartialMethod('cash')} 
                className={`py-3 rounded-xl font-bold text-sm border transition-all ${partialMethod === 'cash' ? 'bg-emerald-100 text-emerald-700 border-emerald-200 ring-2 ring-emerald-500/20' : 'bg-white text-stone-400 border-stone-200'}`}
            >
                <Banknote size={16} className="inline mr-2 mb-0.5"/> Efectivo
            </button>
            <button 
                onClick={() => setPartialMethod('transfer')} 
                className={`py-3 rounded-xl font-bold text-sm border transition-all ${partialMethod === 'transfer' ? 'bg-blue-100 text-blue-700 border-blue-200 ring-2 ring-blue-500/20' : 'bg-white text-stone-400 border-stone-200'}`}
            >
                <CreditCard size={16} className="inline mr-2 mb-0.5"/> Digital
            </button>
        </div>
        {/* -------------------------------------------------------- */}

        {/* 3. Input de Monto (YA LO TIENES) */}
        <div>
            <label className="text-xs font-bold text-stone-500 uppercase">Monto a abonar ahora</label>
            <input type="number" autoFocus className="w-full p-4 text-xl font-bold border rounded-xl mt-1 focus:ring-2 focus:ring-amber-500/20 outline-none" placeholder="$0" value={partialAmount} onChange={e => setPartialAmount(e.target.value)} />
        </div>
        
        {/* 4. Botones de Acción (YA LO TIENES) */}
        <div className="flex gap-3 pt-2">
            <button onClick={() => setPaymentModalStep('select')} className="flex-1 py-3 font-bold text-stone-500 bg-stone-100 rounded-xl">Volver</button>
            <button onClick={() => handleConfirmPayment('partial')} className="flex-[2] bg-amber-600 hover:bg-amber-700 text-white font-bold rounded-xl shadow-lg shadow-amber-900/20">Registrar Entrega</button>
        </div>
    </>
);
                                })()}
                            </div>
                        ) : (
                        <div className="space-y-4">
                                {(() => {
                                    // 1. CALCULAMOS EL TOTAL QUE FALTA PAGAR
                                    const order = orders.find(o => o.id === pendingPaymentId);
                                    const remaining = order ? (order.price - (order.amountPaid || 0)) : 0;

                                    // 2. AL CAMBIAR EFECTIVO -> SE AJUSTA DIGITAL
                                    const handleCashChange = (e) => {
                                        const val = e.target.value;
                                        const numCash = val === '' ? 0 : parseFloat(val);
                                        // Lo que falta se va a digital (sin ser negativo)
                                        const newTransfer = Math.max(0, remaining - numCash); 
                                        setMixedAmounts({ cash: val, transfer: newTransfer });
                                    };

                                    // 3. AL CAMBIAR DIGITAL -> SE AJUSTA EFECTIVO
                                    const handleTransferChange = (e) => {
                                        const val = e.target.value;
                                        const numTransfer = val === '' ? 0 : parseFloat(val);
                                        // Lo que falta se va a efectivo (sin ser negativo)
                                        const newCash = Math.max(0, remaining - numTransfer);
                                        setMixedAmounts({ cash: newCash, transfer: val });
                                    };

                                    return (
                                        <>
                                            <p className="text-sm text-stone-500 font-bold text-center">
                                                Pago Mixto (Total Restante: ${remaining.toLocaleString()})
                                            </p>
                                            <div className="grid grid-cols-2 gap-4">
                                                <div>
                                                    <label className="text-[10px] uppercase font-bold text-stone-400">Efectivo</label>
                                                    <input 
                                                        type="number" 
                                                        className="w-full p-3 border rounded-xl font-bold text-stone-800" 
                                                        value={mixedAmounts.cash} 
                                                        onChange={handleCashChange} 
                                                        placeholder="$0"
                                                    />
                                                </div>
                                                <div>
                                                    <label className="text-[10px] uppercase font-bold text-stone-400">Digital</label>
                                                    <input 
                                                        type="number" 
                                                        className="w-full p-3 border rounded-xl font-bold text-stone-800" 
                                                        value={mixedAmounts.transfer} 
                                                        onChange={handleTransferChange} 
                                                        placeholder="$0"
                                                    />
                                                </div>
                                            </div>
                                            <div className="flex gap-3">
                                                <button onClick={() => setPaymentModalStep('select')} className="flex-1 py-3 font-bold text-stone-500 bg-stone-100 rounded-xl">Volver</button>
                                                <button onClick={() => handleConfirmPayment('mixed')} className="flex-[2] bg-stone-900 text-white font-bold rounded-xl">Confirmar</button>
                                            </div>
                                        </>
                                    );
                                })()}
                            </div>
                        )}
                    </Modal>

                    <Modal isOpen={isIncomeModalOpen} onClose={() => setIsIncomeModalOpen(false)} title={editingFinanceId ? "Editar Ingreso" : "Registrar Ingreso"}>
						<form onSubmit={(e) => { e.preventDefault(); handleSimpleSave('extra_incomes', {...prepareFinanceData(incomeForm), type:'income'}, setIsIncomeModalOpen, setIncomeForm, {description:'', amount:'', method:'cash', mixedCash: '', mixedTransfer: '', date: new Date().toISOString()}, editingFinanceId) }} className="space-y-5">
							{/* CAMPO DE FECHA AGREGADO */}
							<div className="space-y-1">
							<label className="text-xs font-bold text-stone-500 uppercase tracking-widest">Fecha</label>
							<input 
							type="date" 
							className="w-full p-3 bg-stone-50 border rounded-xl" 
							value={incomeForm.date.split('T')[0]} 
							onChange={e => setIncomeForm({...incomeForm, date: e.target.value})} 
							/>
						</div>

						<div className="space-y-1"><label className="text-xs font-bold text-stone-500 uppercase tracking-widest">Concepto</label><input type="text" autoFocus className="w-full p-3 bg-stone-50 border rounded-xl" value={incomeForm.description} onChange={e => setIncomeForm({...incomeForm, description: e.target.value})} /></div>
						<div className="space-y-1"><label className="text-xs font-bold text-stone-500 uppercase tracking-widest">Monto Total</label><input type="number" className="w-full p-3 bg-stone-50 border rounded-xl font-mono" value={incomeForm.amount} onChange={e => setIncomeForm({...incomeForm, amount: e.target.value})} /></div>
        
						<div className="space-y-2">
						<label className="text-xs font-bold text-stone-500 uppercase tracking-widest">Método</label>
							<div className="grid grid-cols-3 gap-3">
							<button type="button" onClick={() => setIncomeForm({...incomeForm, method: 'cash'})} className={`py-3 rounded-xl border font-bold text-sm ${incomeForm.method === 'cash' ? 'bg-stone-800 text-white' : 'bg-white text-stone-500'}`}>Efectivo</button>
							<button type="button" onClick={() => setIncomeForm({...incomeForm, method: 'transfer'})} className={`py-3 rounded-xl border font-bold text-sm ${incomeForm.method === 'transfer' ? 'bg-stone-800 text-white' : 'bg-white text-stone-500'}`}>Digital</button>
							<button type="button" onClick={() => setIncomeForm({...incomeForm, method: 'mixed'})} className={`py-3 rounded-xl border font-bold text-sm ${incomeForm.method === 'mixed' ? 'bg-amber-600 text-white' : 'bg-white text-stone-500'}`}>Mixto</button>
							</div>
							</div>

							{incomeForm.method === 'mixed' && (
							<div className="grid grid-cols-2 gap-4 animate-in slide-in-from-top-2">
								<div className="space-y-1"><label className="text-[10px] font-bold text-stone-400 uppercase">En Efectivo</label><input type="number" className="w-full p-3 bg-stone-50 border border-amber-200 rounded-xl font-bold" value={incomeForm.mixedCash} onChange={e => setIncomeForm({...incomeForm, mixedCash: e.target.value})} /></div>
							<div className="space-y-1"><label className="text-[10px] font-bold text-stone-400 uppercase">En Digital</label><input type="number" className="w-full p-3 bg-stone-50 border border-blue-200 rounded-xl font-bold" value={incomeForm.mixedTransfer} onChange={e => setIncomeForm({...incomeForm, mixedTransfer: e.target.value})} /></div>
							</div>
								)}

						<button type="submit" disabled={isSaving} className="w-full bg-emerald-600 text-white py-3.5 rounded-xl font-bold">{editingFinanceId ? 'Guardar Cambios' : 'Registrar'}</button>
						</form>
					</Modal>

                    <Modal isOpen={isExpenseModalOpen} onClose={() => setIsExpenseModalOpen(false)} title={editingFinanceId ? "Editar Gasto" : "Registrar Gasto"}>
						<form onSubmit={(e) => { e.preventDefault(); handleSimpleSave('expenses', {...prepareFinanceData(expenseForm), type:'expense'}, setIsExpenseModalOpen, setExpenseForm, {description:'', amount:'', method:'cash', mixedCash: '', mixedTransfer: '', date: new Date().toISOString()}, editingFinanceId) }} className="space-y-5">
						{/* CAMPO DE FECHA AGREGADO */}
						<div className="space-y-1">
						<label className="text-xs font-bold text-stone-500 uppercase tracking-widest">Fecha</label>
						<input 
							type="date" 
							className="w-full p-3 bg-stone-50 border rounded-xl" 
							value={expenseForm.date.split('T')[0]} 
							onChange={e => setExpenseForm({...expenseForm, date: e.target.value})} 
									/>
						</div>

						<div className="space-y-1"><label className="text-xs font-bold text-stone-500 uppercase tracking-widest">Concepto</label><input type="text" autoFocus className="w-full p-3 bg-stone-50 border rounded-xl" value={expenseForm.description} onChange={e => setExpenseForm({...expenseForm, description: e.target.value})} /></div>
						<div className="space-y-1"><label className="text-xs font-bold text-stone-500 uppercase tracking-widest">Monto Total</label><input type="number" className="w-full p-3 bg-stone-50 border rounded-xl font-mono" value={expenseForm.amount} onChange={e => setExpenseForm({...expenseForm, amount: e.target.value})} /></div>
        
						<div className="space-y-2">
						<label className="text-xs font-bold text-stone-500 uppercase tracking-widest">Método</label>
						<div className="grid grid-cols-3 gap-3">
							<button type="button" onClick={() => setExpenseForm({...expenseForm, method: 'cash'})} className={`py-3 rounded-xl border font-bold text-sm ${expenseForm.method === 'cash' ? 'bg-stone-800 text-white' : 'bg-white text-stone-500'}`}>Efectivo</button>
							<button type="button" onClick={() => setExpenseForm({...expenseForm, method: 'transfer'})} className={`py-3 rounded-xl border font-bold text-sm ${expenseForm.method === 'transfer' ? 'bg-stone-800 text-white' : 'bg-white text-stone-500'}`}>Digital</button>
							<button type="button" onClick={() => setExpenseForm({...expenseForm, method: 'mixed'})} className={`py-3 rounded-xl border font-bold text-sm ${expenseForm.method === 'mixed' ? 'bg-amber-600 text-white' : 'bg-white text-stone-500'}`}>Mixto</button>
						</div>
						</div>

						{expenseForm.method === 'mixed' && (
					<div className="grid grid-cols-2 gap-4 animate-in slide-in-from-top-2">
					<div className="space-y-1"><label className="text-[10px] font-bold text-stone-400 uppercase">En Efectivo</label><input type="number" className="w-full p-3 bg-stone-50 border border-amber-200 rounded-xl font-bold" value={expenseForm.mixedCash} onChange={e => setExpenseForm({...expenseForm, mixedCash: e.target.value})} /></div>
					<div className="space-y-1"><label className="text-[10px] font-bold text-stone-400 uppercase">En Digital</label><input type="number" className="w-full p-3 bg-stone-50 border border-blue-200 rounded-xl font-bold" value={expenseForm.mixedTransfer} onChange={e => setExpenseForm({...expenseForm, mixedTransfer: e.target.value})} /></div>
					</div>
        )}

					<button type="submit" disabled={isSaving} className="w-full bg-red-500 text-white py-3.5 rounded-xl font-bold">{editingFinanceId ? 'Guardar Cambios' : 'Registrar'}</button>
					</form>
					</Modal>

                    {/* DEBT MODAL UPDATE */}
                    <Modal isOpen={isDebtModalOpen} onClose={() => setIsDebtModalOpen(false)} title="Nueva Deuda">
                         <form onSubmit={handleSaveDebt} className="space-y-5">
                            
                            {/* Selector de Modo */}
                            <div className="grid grid-cols-3 gap-2 bg-stone-100 p-1 rounded-xl">
                                <button type="button" onClick={() => setDebtForm({...debtForm, mode: 'single'})} className={`py-2 text-xs font-bold rounded-lg transition-all ${debtForm.mode === 'single' ? 'bg-white text-stone-900 shadow-sm' : 'text-stone-500 hover:text-stone-700'}`}>Única</button>
                                <button type="button" onClick={() => setDebtForm({...debtForm, mode: 'installments'})} className={`py-2 text-xs font-bold rounded-lg transition-all ${debtForm.mode === 'installments' ? 'bg-white text-stone-900 shadow-sm' : 'text-stone-500 hover:text-stone-700'}`}>Cuotas</button>
                                <button type="button" onClick={() => setDebtForm({...debtForm, mode: 'fixed'})} className={`py-2 text-xs font-bold rounded-lg transition-all ${debtForm.mode === 'fixed' ? 'bg-white text-stone-900 shadow-sm' : 'text-stone-500 hover:text-stone-700'}`}>Fijo Anual</button>
                            </div>

                            <div className="space-y-1"><label className="text-xs font-bold text-stone-500 uppercase tracking-widest">Detalle</label><input type="text" autoFocus className="w-full p-3 bg-stone-50 border rounded-xl" placeholder={debtForm.mode === 'fixed' ? 'Ej: Alquiler Local' : 'Ej: Compra Mercadería'} value={debtForm.detail} onChange={e => setDebtForm({...debtForm, detail: e.target.value})} /></div>
                            
                            <div className="space-y-1"><label className="text-xs font-bold text-stone-500 uppercase tracking-widest">{debtForm.mode === 'single' ? 'Monto' : (debtForm.mode === 'installments' ? 'Valor de Cuota' : 'Valor Mensual')}</label><input type="number" className="w-full p-3 bg-stone-50 border rounded-xl font-mono" value={debtForm.amount} onChange={e => setDebtForm({...debtForm, amount: e.target.value})} /></div>

                            {debtForm.mode === 'installments' && (
                                <div className="grid grid-cols-2 gap-4 animate-in slide-in-from-top-2">
                                    <div className="space-y-1"><label className="text-xs font-bold text-stone-500 uppercase tracking-widest">Cant. Cuotas</label><input type="number" min="2" className="w-full p-3 bg-stone-50 border rounded-xl" value={debtForm.quotaCount} onChange={e => setDebtForm({...debtForm, quotaCount: e.target.value})} /></div>
                                    <div className="space-y-1"><label className="text-xs font-bold text-stone-500 uppercase tracking-widest">Inicio (Mes/Año)</label><input type="month" className="w-full p-3 bg-stone-50 border rounded-xl" value={debtForm.startMonth} onChange={e => setDebtForm({...debtForm, startMonth: e.target.value})} /></div>
                                </div>
                            )}

                            {debtForm.mode === 'fixed' && (
                                <div className="animate-in slide-in-from-top-2">
                                    <div className="space-y-1"><label className="text-xs font-bold text-stone-500 uppercase tracking-widest">Año Correspondiente</label><input type="number" min="2024" max="2030" className="w-full p-3 bg-stone-50 border rounded-xl" value={debtForm.year} onChange={e => setDebtForm({...debtForm, year: e.target.value})} /></div>
                                    <p className="text-xs text-stone-400 mt-2 italic">* Se generarán 12 deudas (Ene-Dic) para el año seleccionado.</p>
                                </div>
                            )}

                            <button type="submit" disabled={isSaving} className="w-full bg-stone-900 text-white py-3.5 rounded-xl font-bold">
                                {debtForm.mode === 'single' ? 'Guardar Deuda' : 'Generar Plan de Pagos'}
                            </button>
                        </form>
                    </Modal>

                    <Modal isOpen={isSettingsOpen} onClose={() => setIsSettingsOpen(false)} title="Seguridad">
                        <form onSubmit={handleUpdateCredentials} className="space-y-5">
                            <p className="text-sm text-stone-500 bg-amber-50 p-3 rounded-lg border border-amber-100">Aquí puedes actualizar tu usuario y contraseña de acceso.</p>
                            <div className="space-y-1"><label className="text-xs font-bold text-stone-500 uppercase">Usuario</label><input type="text" className="w-full p-3 border rounded-xl" value={tempCredentials.user} onChange={e => setTempCredentials({...tempCredentials, user: e.target.value})} /></div>
                            <div className="space-y-1"><label className="text-xs font-bold text-stone-500 uppercase">Contraseña</label><input type="text" className="w-full p-3 border rounded-xl" value={tempCredentials.pass} onChange={e => setTempCredentials({...tempCredentials, pass: e.target.value})} /></div>
                            <button type="submit" className="w-full bg-stone-900 text-white py-3 rounded-xl font-bold">Actualizar</button>
                        </form>
                    </Modal>
					
					{/* --- MODAL DE ENTREGA (FALTABA ESTO) --- */}
<Modal isOpen={isDeliveryModalOpen} onClose={() => setIsDeliveryModalOpen(false)} title="Confirmar Entrega">
    {(() => {
        const order = orders.find(o => o.id === pendingDeliveryId);
        if (!order) return null;
        return (
            <div className="space-y-6">
                <div className="bg-blue-50 border border-blue-100 rounded-xl p-4 flex gap-4 items-start animate-in fade-in slide-in-from-top-2">
                    <div className="bg-white p-2.5 rounded-full text-blue-600 shrink-0 shadow-sm border border-blue-100">
                        <Truck size={22} strokeWidth={2} />
                    </div>
                    <div>
                        <h4 className="font-bold text-blue-900 text-sm mb-1">Entregando pedido:</h4>
                        <p className="text-blue-700 text-xs font-medium leading-relaxed">{order.detail}</p>
                    </div>
                </div>

                <div className="space-y-1">
                    <label className="text-xs font-bold text-stone-500 uppercase tracking-widest ml-1">Fecha de Entrega</label>
                    <div className="relative">
                        <input type="datetime-local" className="w-full p-3.5 pl-10 bg-stone-50 border border-stone-200 rounded-xl focus:border-stone-400 outline-none font-medium text-stone-700 shadow-sm transition-all" value={deliveryDateInput} onChange={(e) => setDeliveryDateInput(e.target.value)} />
                        <Calendar className="absolute left-3.5 top-1/2 -translate-y-1/2 text-stone-400" size={18} />
                    </div>
                </div>

                <div className="flex gap-3 pt-2">
                    <button onClick={() => setIsDeliveryModalOpen(false)} className="flex-1 py-3.5 rounded-xl font-bold bg-stone-100 text-stone-600 hover:bg-stone-200 transition-colors">Cancelar</button>
                    <button onClick={handleDeliveryConfirm} className="flex-1 py-3.5 rounded-xl font-bold bg-stone-900 text-white hover:bg-stone-800 transition-colors shadow-lg shadow-stone-900/20 active:scale-95 transform duration-100">Confirmar</button>
                </div>
            </div>
        );
    })()}
</Modal>
                    
{/* MODAL DE REALIZADO (PASO 7 FINAL) */}
                    <Modal isOpen={isDoneModalOpen} onClose={() => setIsDoneModalOpen(false)} title="Confirmar Realización">
                        {(() => {
                            const order = orders.find(o => o.id === pendingDoneId);
                            if (!order) return null;
                            return (
                                <div className="space-y-6">
                                    <div className="bg-purple-50 border border-purple-100 rounded-xl p-4 flex gap-4 items-start animate-in fade-in slide-in-from-top-2">
                                        <div className="bg-white p-2.5 rounded-full text-purple-600 shrink-0 shadow-sm border border-purple-100">
                                            <Scissors size={22} strokeWidth={2} />
                                        </div>
                                        <div>
                                            <h4 className="font-bold text-purple-900 text-sm mb-1">Pedido listo/confeccionado:</h4>
                                            <p className="text-purple-700 text-xs font-medium leading-relaxed">{order.detail}</p>
                                        </div>
                                    </div>

                                    <div className="space-y-1">
                                        <label className="text-xs font-bold text-stone-500 uppercase tracking-widest ml-1">Fecha de finalización</label>
                                        <div className="relative">
                                            <input type="datetime-local" className="w-full p-3.5 pl-10 bg-stone-50 border border-stone-200 rounded-xl focus:border-stone-400 outline-none font-medium text-stone-700 shadow-sm transition-all" value={doneDateInput} onChange={(e) => setDoneDateInput(e.target.value)} />
                                            <Calendar className="absolute left-3.5 top-1/2 -translate-y-1/2 text-stone-400" size={18} />
                                        </div>
                                    </div>

                                    <div className="flex gap-3 pt-2">
                                        <button onClick={() => setIsDoneModalOpen(false)} className="flex-1 py-3.5 rounded-xl font-bold bg-stone-100 text-stone-600 hover:bg-stone-200 transition-colors">Cancelar</button>
                                        <button onClick={handleDoneConfirm} className="flex-1 py-3.5 rounded-xl font-bold bg-stone-900 text-white hover:bg-stone-800 transition-colors shadow-lg shadow-stone-900/20 active:scale-95 transform duration-100">Confirmar</button>
                                    </div>
                                </div>
                            );
                        })()}
                    </Modal>

                    <ConfirmModal isOpen={confirmModal.isOpen} onClose={() => setConfirmModal({...confirmModal, isOpen: false})} title={confirmModal.title} message={confirmModal.message} onConfirm={confirmModal.onConfirm} isDanger={confirmModal.isDanger} confirmText={confirmModal.confirmText} />
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<OsirisApp />);
    </script>
</body>
</html>
